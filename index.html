<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Yotyosr â€” ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨ÙŠÙˆØªÙŠÙˆØ¨ | PWA Ù…ØªÙ‚Ø¯Ù…</title>
<meta name="theme-color" content="#0ea5e9" />

<style>
  :root{
    --bg:#0f0f0f; --surface:#121212; --header:#0f0f0f; --sidebar:#0f0f0f;
    --text:#ffffff; --muted:#b3b3b3; --border:#303030;
    --accent:#0ea5e9; --accent2:#22d3ee;
    --header-h:56px; --sidebar-w:240px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Roboto,"Segoe UI",Tahoma,sans-serif}

  /* Ø«Ø§Ø¨Øª Ø£Ø¹Ù„Ù‰ */
  .header{
    position:fixed; top:0; left:0; right:0; height:var(--header-h);
    display:flex; align-items:center; justify-content:space-between;
    padding:0 16px; background:var(--header); border-bottom:1px solid var(--border); z-index:1000;
  }
  .header-left{display:flex; align-items:center; gap:12px}
  .logo{display:flex; align-items:center; gap:8px; font-weight:700}
  .logo .play{width:26px; height:18px; background:#fff; clip-path:polygon(0 0,100% 50%,0 100%)}
  .logo .name{letter-spacing:.2px}
  .search{display:flex; align-items:center; gap:0; flex:1; max-width:700px; margin:0 16px}
  .search input{
    flex:1; height:40px; background:var(--surface); border:1px solid var(--border); color:#fff; padding:0 12px;
    border-radius:20px 0 0 20px; outline:none;
  }
  .search button{
    height:40px; width:64px; border:1px solid var(--border); border-left:none;
    border-radius:0 20px 20px 0; background:#222; color:#fff; cursor:pointer;
  }
  .header-right{display:flex; align-items:center; gap:10px}
  .install-btn{
    padding:8px 12px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none; color:#fff; cursor:pointer
  }
  .icon-btn{width:40px; height:40px; display:grid; place-items:center; border-radius:999px; background:#222; border:1px solid var(--border); cursor:pointer}

  /* Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± Ø«Ø§Ø¨Øª */
  .sidebar{
    position:fixed; top:var(--header-h); bottom:0; left:0; width:var(--sidebar-w);
    background:var(--sidebar); border-right:1px solid var(--border); padding:8px 0;
    overflow:auto; z-index:900;
  }
  .section-title{padding:8px 16px; color:#bbb; font-size:.9rem; margin-top:6px}
  .nav-item{
    display:flex; align-items:center; gap:12px;
    padding:10px 16px; border-radius:10px; cursor:pointer; color:#e6e6e6;
  }
  .nav-item:hover{background:#1f1f1f}

  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ â€” ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
  .main{
    position:relative;
    margin-left:var(--sidebar-w);
    padding-top:var(--header-h);
    min-height:100vh;
  }

  /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ø«Ø¨Øª ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  .chips{
    position:sticky; top:calc(var(--header-h));
    display:flex; gap:8px; padding:12px 16px; background:var(--bg); border-bottom:1px solid var(--border); z-index:800;
  }
  .chip{padding:8px 12px; background:#272727; border:1px solid var(--border); border-radius:999px; color:#ddd; cursor:pointer; white-space:nowrap}
  .chip.active{background:#fff; color:#000; border-color:#fff}

  /* Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; padding:16px}
  .card{display:flex; flex-direction:column; gap:8px; cursor:pointer}
  .thumb{width:100%; aspect-ratio:16/9; background:#111; border-radius:12px; overflow:hidden; object-fit:cover}
  .row{display:flex; gap:10px}
  .avatar{width:36px; height:36px; border-radius:999px; background:#333; flex-shrink:0}
  .meta{display:flex; flex-direction:column; gap:2px}
  .title{font-weight:500; line-height:1.3}
  .sub{color:#aaa; font-size:.9rem}

  /* ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© */
  .watch{display:grid; grid-template-columns:1fr 420px; gap:16px; padding:16px}
  .player-wrap{background:#000; border-radius:12px; overflow:hidden}
  .player-wrap video{width:100%; height:auto; display:block; background:#000}
  .watch-title{font-size:1.2rem; font-weight:600; margin-top:8px}
  .watch-actions{display:flex; gap:8px; margin:8px 0; flex-wrap:wrap}
  .btn{padding:8px 12px; border-radius:999px; background:#272727; border:1px solid var(--border); color:#fff; cursor:pointer}
  .btn.secondary{background:#1f1f1f}
  .watch-meta{color:#aaa; font-size:.9rem}
  .suggestions{display:flex; flex-direction:column; gap:12px}
  .sugg-card{display:flex; gap:10px; cursor:pointer}
  .sugg-thumb{width:180px; aspect-ratio:16/9; background:#111; border-radius:8px; overflow:hidden; object-fit:cover; flex-shrink:0}
  .sugg-meta{display:flex; flex-direction:column; gap:2px}
  .divider{height:1px; background:var(--border); margin:12px 0}

  /* Toast + offline */
  .toast{
    position:fixed; right:20px; bottom:20px; background:rgba(16,185,129,.15); color:#d1fae5; border:1px solid rgba(16,185,129,.45);
    padding:10px 14px; border-radius:12px; backdrop-filter: blur(10px);
    transform: translateY(20px); opacity:0; pointer-events:none; transition:.35s ease; z-index:1100;
  }
  .toast.show{transform:translateY(0); opacity:1; pointer-events:auto}
  .offline{
    position:fixed; left:20px; bottom:20px; background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.4);
    padding:8px 12px; border-radius:10px; z-index:1100
  }

  /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  @media (max-width: 900px){
    :root{ --sidebar-w:0px; }
    .sidebar{display:none}
    .main{margin-left:0}
    .watch{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
<div class="header">
  <div class="header-left">
    <div class="logo">
      <div class="play"></div>
      <div class="name">Yotyosr</div>
    </div>
  </div>
  <div class="search">
    <input id="searchInp" type="text" placeholder="Ø§Ø¨Ø­Ø«" />
    <button id="searchBtn">Ø¨Ø­Ø«</button>
  </div>
  <div class="header-right">
    <button id="installBtn" class="install-btn" disabled>ØªØ«Ø¨ÙŠØª</button>
    <div class="icon-btn" title="Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">ğŸ””</div>
    <div class="icon-btn" title="Ø­Ø³Ø§Ø¨">ğŸ‘¤</div>
  </div>
</div>

<!-- Ø§Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± -->
<div class="sidebar" id="sidebar">
  <div class="section-title">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
  <div class="nav-item" data-chip="Ø§Ù„ÙƒÙ„">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
  <div class="nav-item" data-chip="Ù…ÙˆØ³ÙŠÙ‚Ù‰">Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
  <div class="nav-item" data-chip="Ø£Ù„Ø¹Ø§Ø¨">Ø£Ù„Ø¹Ø§Ø¨</div>
  <div class="nav-item" data-chip="ØªØ¹Ù„ÙŠÙ…ÙŠ">ØªØ¹Ù„ÙŠÙ…ÙŠ</div>
  <div class="nav-item" data-chip="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</div>
  <div class="section-title">Ø£Ø¯ÙˆØ§Øª</div>
  <div class="nav-item" id="pipNav">ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</div>
  <div class="nav-item" id="homeNav">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="main">
  <div class="chips" id="chips">
    <div class="chip active" data-chip="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</div>
    <div class="chip" data-chip="Ù…ÙˆØ³ÙŠÙ‚Ù‰">Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
    <div class="chip" data-chip="Ø£Ù„Ø¹Ø§Ø¨">Ø£Ù„Ø¹Ø§Ø¨</div>
    <div class="chip" data-chip="ØªØ¹Ù„ÙŠÙ…ÙŠ">ØªØ¹Ù„ÙŠÙ…ÙŠ</div>
    <div class="chip" data-chip="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</div>
  </div>

  <div id="homeView">
    <div class="grid" id="grid"></div>
  </div>

  <div id="watchView" style="display:none">
    <div class="watch">
      <div>
        <div class="player-wrap"><video id="player" controls playsinline></video></div>
        <div class="watch-title" id="watchTitle">â€”</div>
        <div class="watch-actions">
          <button class="btn" id="likeBtn">ğŸ‘ Ø£Ø¹Ø¬Ø¨Ù†ÙŠ</button>
          <button class="btn" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
          <button class="btn" id="speedBtn">âš¡ Ø§Ù„Ø³Ø±Ø¹Ø©</button>
          <button class="btn" id="pipBtn">ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</button>
          <button class="btn secondary" id="backBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
        </div>
        <div class="watch-meta" id="watchMeta">â€”</div>
        <div class="divider"></div>
        <div class="watch-meta">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØºÙŠØ± Ù…ÙØ¹Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.</div>
      </div>
      <div>
        <div class="suggestions" id="suggestions"></div>
      </div>
    </div>
  </div>
</div>

<!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="offline" class="offline" hidden>Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª -->
<canvas id="appIconCanvas" width="128" height="128" style="position:fixed;left:-9999px;top:-9999px"></canvas>
<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />

<script>
/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const showToast = (msg, ok=true) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.12)';
  t.style.color = ok ? '#d1fae5' : '#fecaca';
  t.style.borderColor = ok ? 'rgba(16,185,129,.45)' : 'rgba(239,68,68,.4)';
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 3000);
};

/* ========= Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ========= */
function generateIcon(size=192){
  const c = $('#appIconCanvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  const g = ctx.createLinearGradient(0,0,size,size);
  g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#22d3ee');
  ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
  ctx.fillStyle='#0b1220'; ctx.beginPath(); ctx.arc(size/2,size/2,size*0.45,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.beginPath();
  ctx.moveTo(size*0.45, size*0.35);
  ctx.lineTo(size*0.45, size*0.65);
  ctx.lineTo(size*0.70, size*0.50);
  ctx.closePath(); ctx.fill();
  return c.toDataURL('image/png');
}

/* ========= Ø­Ù‚Ù† Manifest ========= */
function injectManifest(){
  const icon192 = generateIcon(192);
  const icon512 = generateIcon(512);
  $('#appIconLink').href = icon192;
  const manifest = {
    name: "Yotyosr â€” ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨ÙŠÙˆØªÙŠÙˆØ¨ | PWA",
    short_name: "Yotyosr",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0f0f0f",
    theme_color: "#0ea5e9",
    description: "Ù…Ù†ØµØ© Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨ÙŠÙˆØªÙŠÙˆØ¨.",
    icons: [
      { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ],
    shortcuts: [
      { name:"Ø¨Ø­Ø«", url:"./?focus=search", description:"ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«" },
      { name:"Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©", url:"./?resume=1", description:"ÙØªØ­ Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ" }
    ]
  };
  const dataUrl = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(JSON.stringify(manifest))));
  $('#manifestLink').href = dataUrl;
}

/* ========= Service Worker ========= */
async function registerSW(){
  const swCode = `
    const CACHE='yotyosr-cache-v1';
    const CORE=['.','videos.json'];
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch',e=>{
      const req=e.request; const url=new URL(req.url);
      if(req.method==='GET' && url.origin===self.location.origin){
        e.respondWith(
          caches.match(req).then(res=>{
            return res || fetch(req).then(net=>{
              const copy=net.clone();
              const ct = copy.headers.get('content-type') || '';
              if(!ct.startsWith('video/')){ caches.open(CACHE).then(c=>c.put(req, copy)).catch(()=>{}); }
              return net;
            }).catch(()=> caches.match('.'));
          })
        );
      }
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  try{
    await navigator.serviceWorker.register(swUrl,{scope:'.'});
    showToast('Service Worker Ø¬Ø§Ù‡Ø² ğŸ›¡ï¸');
    setTimeout(()=> URL.revokeObjectURL(swUrl), 4000);
  }catch(e){ console.error(e); showToast('ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Service Worker', false); }
}

/* ========= Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ========= */
function updateOnline(){ $('#offline').hidden = navigator.onLine; }
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);

/* ========= Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ========= */
let library = []; // {id,title,channel,views:number,age,url,thumb,category}
const LS_LAST = 'yotyosr.last';
function setLastIndex(i){ localStorage.setItem(LS_LAST, String(i)); }
function getLastIndex(){ const v = localStorage.getItem(LS_LAST); return v?Number(v):-1; }

async function fetchLibrary(){
  try{
    const res = await fetch('videos.json', {cache:'no-store'});
    library = await res.json();
  }catch(e){
    showToast('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª', false);
    library = [];
  }
}

/* ========= ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù†ØµÙŠØ© Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† thumb ========= */
function makeThumbText(w=1280,h=720,text='Yotyosr'){
  const cn = document.createElement('canvas'); cn.width=w; cn.height=h;
  const ctx = cn.getContext('2d');
  const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#202020'); g.addColorStop(1,'#404040');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#fff'; ctx.font='bold 64px "Segoe UI", Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(text, w/2, h/2);
  ctx.fillStyle='#0ea5e9'; ctx.beginPath(); ctx.moveTo(w/2 - 60, h/2 - 40); ctx.lineTo(w/2 - 60, h/2 + 40); ctx.lineTo(w/2 + 20, h/2); ctx.closePath(); ctx.fill();
  return cn.toDataURL('image/jpeg', 0.9);
}

/* ========= Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ========= */
function renderHome(){
  $('#homeView').style.display='block';
  $('#watchView').style.display='none';

  const q = ($('#searchInp').value||'').trim().toLowerCase();
  const activeChip = [...$$('.chip')].find(c=> c.classList.contains('active'))?.dataset.chip || 'Ø§Ù„ÙƒÙ„';
  const grid = $('#grid'); grid.innerHTML='';

  library
    .filter(it=> (activeChip==='Ø§Ù„ÙƒÙ„' || it.category===activeChip))
    .filter(it=> it.title.toLowerCase().includes(q) || (it.channel||'').toLowerCase().includes(q))
    .forEach((it, idx)=>{
      const card = document.createElement('div'); card.className='card';
      const th = document.createElement('img'); th.className='thumb'; th.src = it.thumb || makeThumbText(1280,720,it.title); th.alt = it.title; th.loading='lazy';
      const row = document.createElement('div'); row.className='row';
      const avatar = document.createElement('div'); avatar.className='avatar';
      const meta = document.createElement('div'); meta.className='meta';
      const title = document.createElement('div'); title.className='title'; title.textContent = it.title;
      const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${it.channel} â€¢ ${it.views} Ù…Ø´Ø§Ù‡Ø¯Ø© â€¢ ${it.age}`;
      meta.appendChild(title); meta.appendChild(sub);
      row.appendChild(avatar); row.appendChild(meta);
      card.appendChild(th); card.appendChild(row);
      card.addEventListener('click', ()=> openWatchByIndex(idx));
      grid.appendChild(card);
    });
}

/* ========= ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ========= */
const player = $('#player');
function openWatchByIndex(i){
  const it = library[i]; if(!it) return;
  $('#homeView').style.display='none';
  $('#watchView').style.display='block';
  $('#watchTitle').textContent = it.title;
  $('#watchMeta').textContent = `${it.channel} â€¢ ${it.views} Ù…Ø´Ø§Ù‡Ø¯Ø© â€¢ ${it.age}`;
  player.src = it.url;
  player.play().catch(()=>{});
  setLastIndex(i);

  // Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
  const sugg = $('#suggestions'); sugg.innerHTML='';
  library.filter((s,idx)=> idx!==i).slice(0,10).forEach((s)=>{
    const sc = document.createElement('div'); sc.className='sugg-card';
    const th = document.createElement('img'); th.className='sugg-thumb'; th.src = s.thumb || makeThumbText(640,360,s.title); th.alt = s.title;
    const m = document.createElement('div'); m.className='sugg-meta';
    const tt = document.createElement('div'); tt.textContent = s.title; tt.style.fontWeight='500';
    const sb = document.createElement('div'); sb.textContent = `${s.channel} â€¢ ${s.views} Ù…Ø´Ø§Ù‡Ø¯Ø©`; sb.style.color='#aaa';
    m.appendChild(tt); m.appendChild(sb);
    sc.appendChild(th); sc.appendChild(m);
    sc.addEventListener('click', ()=> openWatchByIndex(library.indexOf(s)));
    sugg.appendChild(sc);
  });

  // Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ù…Ø­Ù„ÙŠ
  it.views = (Number(it.views)||0) + 1;
}

/* ========= Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ø¬Ù‡Ø© ========= */
$('#searchBtn').addEventListener('click', renderHome);
$('#searchInp').addEventListener('input', renderHome);
$('#chips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  $$('.chip').forEach(c=> c.classList.remove('active'));
  chip.classList.add('active');
  renderHome();
});
$('#homeNav').addEventListener('click', renderHome);
$('#backBtn').addEventListener('click', renderHome);

/* ========= PiP + Ø§Ù„Ø³Ø±Ø¹Ø© + Ù…Ø´Ø§Ø±ÙƒØ© ========= */
$('#pipBtn').addEventListener('click', async ()=>{
  if(document.pictureInPictureEnabled && !player.disablePictureInPicture){ try{ await player.requestPictureInPicture(); }catch{} }
  else showToast('PiP ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', false);
});
$('#pipNav').addEventListener('click', async ()=>{
  if(document.pictureInPictureEnabled && !player.disablePictureInPicture){ try{ await player.requestPictureInPicture(); }catch{} }
  else showToast('PiP ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', false);
});
$('#speedBtn').addEventListener('click', ()=>{
  const rates = [0.5, 0.75, 1, 1.25, 1.5, 2];
  const cur = player.playbackRate;
  const idx = (rates.indexOf(cur)+1) % rates.length;
  player.playbackRate = rates[idx];
  showToast('Ø§Ù„Ø³Ø±Ø¹Ø©: ' + rates[idx] + 'Ã—');
});
$('#shareBtn').addEventListener('click', async ()=>{
  const i = getLastIndex(); const it = library[i];
  if(navigator.share && it){
    try{ await navigator.share({title: it.title, text: it.channel, url: location.href}); showToast('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© âœ…'); }
    catch{ showToast('Ø£ÙÙ„ØºÙŠØª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', false); }
  }else showToast('ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©', false);
});
$('#likeBtn').addEventListener('click', ()=> showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ â¤ï¸'));

/* ========= Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ========= */
document.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if(k==='k'){ if(player.paused) player.play(); else player.pause(); }
  if(k==='j'){ player.currentTime = Math.max(0, player.currentTime - 10); }
  if(k==='l'){ player.currentTime = Math.min(player.duration||player.currentTime+10, player.currentTime + 10); }
});

/* ========= ØªØ«Ø¨ÙŠØª PWA ========= */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt=e;
  // Ù†ÙØ¹Ù‘Ù„ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ø¹Ø¯ Ù„Ø­Ø¸Ø©
  setTimeout(()=> { $('#installBtn').disabled=false; }, 200);
});
$('#installBtn').addEventListener('click', async ()=>{
  if(!deferredPrompt) return; deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice; deferredPrompt=null; $('#installBtn').disabled=true;
  showToast(outcome==='accepted' ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ğŸ‰' : 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª');
});

/* ========= ØªÙ‡ÙŠØ¦Ø© ========= */
async function init(){
  injectManifest();
  updateOnline();
  await registerSW();
  await fetchLibrary();
  renderHome();

  const params = new URLSearchParams(location.search);
  if(params.get('focus')==='search'){ $('#searchInp').focus(); }
  if(params.has('resume')){ const i = getLastIndex(); if(i>=0) openWatchByIndex(i); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
