<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Yotyosr â€” Ù…Ø´ØºÙ‘Ù„ ÙÙŠØ¯ÙŠÙˆ Ø²Ø¬Ø§Ø¬ÙŠ | PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù</title>
<meta name="theme-color" content="#0ea5e9" />

<style>
  :root{
    --bg:#0b1220; --glass:rgba(255,255,255,.08); --glass2:rgba(255,255,255,.12);
    --text:#e6f2ff; --muted:#a9c2d9; --accent:#0ea5e9; --accent2:#22d3ee;
    --shadow:0 20px 40px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{margin:0; min-height:100%; background:radial-gradient(1000px 700px at 10% 10%, #0f1b33 0%, #0b1220 45%, #070c16 100%); color:var(--text); font-family:"Segoe UI",Tahoma,sans-serif}
  .container{max-width:1200px; margin:0 auto; padding:20px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
  .brand{display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px; background:var(--glass); backdrop-filter:blur(12px); box-shadow:var(--shadow)}
  .brand canvas{width:42px; height:42px; border-radius:10px}
  .brand .titles{display:flex; flex-direction:column}
  .brand .name{font-weight:700; letter-spacing:.3px}
  .brand .sub{color:var(--muted); font-size:.9rem}
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  button{
    appearance:none; border:none; border-radius:12px; padding:10px 14px; color:#fff; font-weight:600; cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:var(--shadow)
  }
  button.secondary{
    background:linear-gradient(135deg,rgba(255,255,255,.16),rgba(255,255,255,.08)); color:var(--text)
  }
  button:disabled{opacity:.6; cursor:not-allowed}
  .layout{display:grid; grid-template-columns: 320px 1fr; gap:16px}
  .panel{border-radius:var(--radius); background:var(--glass); backdrop-filter:blur(18px); box-shadow:var(--shadow); overflow:hidden}
  .panel .hd{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25); font-weight:600}
  .panel .bd{padding:12px}
  .search{display:flex; gap:8px; margin-bottom:12px}
  .input, input[type="text"]{
    flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); color:var(--text);
    background:rgba(255,255,255,.06)
  }
  .list{display:grid; grid-template-columns:1fr; gap:10px}
  .card{display:flex; gap:10px; border-radius:12px; background:rgba(255,255,255,.06); overflow:hidden; box-shadow:var(--shadow)}
  .thumb{width:120px; height:72px; background:#111; flex-shrink:0}
  .meta{display:flex; flex-direction:column; justify-content:center}
  .meta .title{font-weight:600}
  .meta .sub{color:var(--muted); font-size:.9rem}
  .player{display:flex; flex-direction:column; gap:12px}
  .video-wrap{position:relative; border-radius:12px; overflow:hidden; background:#000}
  video{width:100%; height:auto; display:block; background:#000}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.08); color:var(--muted); font-size:.9rem}
  .small{font-size:.85rem}
  .toast{
    position:fixed; right:20px; bottom:20px; background:rgba(16,185,129,.15); color:#d1fae5; border:1px solid rgba(16,185,129,.45);
    padding:10px 14px; border-radius:12px; backdrop-filter: blur(10px); box-shadow: var(--shadow);
    transform: translateY(20px); opacity:0; pointer-events:none; transition:.35s ease;
  }
  .toast.show{transform:translateY(0); opacity:1; pointer-events:auto}
  .offline{position:fixed; left:20px; bottom:20px; background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.4); padding:8px 12px; border-radius:10px; backdrop-filter: blur(10px)}
  .drop{border:2px dashed rgba(255,255,255,.18); border-radius:12px; padding:10px; text-align:center; color:var(--muted)}
  .kbd{background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); border-radius:6px; padding:2px 6px; font-family:Consolas,monospace}
</style>

<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <canvas id="appIconCanvas" width="128" height="128" aria-hidden="true"></canvas>
      <div class="titles">
        <div class="name">Yotyosr</div>
        <div class="sub">Ù…Ø´ØºÙ‘Ù„ ÙÙŠØ¯ÙŠÙˆ Ø²Ø¬Ø§Ø¬ÙŠ â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª ÙˆÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†</div>
      </div>
    </div>
    <div class="actions">
      <button id="installBtn" disabled>ØªØ«Ø¨ÙŠØª</button>
      <button id="addUrlBtn">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ</button>
      <button id="importBtn" class="secondary">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <button id="exportBtn" class="secondary">ØªØµØ¯ÙŠØ± JSON</button>
    </div>
  </header>

  <div class="layout">
    <div class="panel">
      <div class="hd">Ø§Ù„Ù…ÙƒØªØ¨Ø©</div>
      <div class="bd">
        <div class="search">
          <input id="searchInp" class="input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..." />
          <button id="clearSearchBtn" class="secondary">Ù…Ø³Ø­</button>
        </div>
        <div id="dropZone" class="drop">Ø§Ø³Ø­Ø¨ Ù…Ù„ÙØ§Øª ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§ Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
        <div id="list" class="list" aria-live="polite"></div>
      </div>
    </div>

    <div class="panel">
      <div class="hd">Ø§Ù„Ù…Ø´ØºÙ‘Ù„</div>
      <div class="bd">
        <div class="player">
          <div class="video-wrap">
            <video id="player" playsinline controls></video>
          </div>
          <div class="controls">
            <button id="prevBtn" class="secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button id="nextBtn" class="secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button id="pipBtn" class="secondary">ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</button>
            <button id="thumbBtn" class="secondary">ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø©</button>
            <span class="pill">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
            <select id="speedSel">
              <option value="0.5">0.5Ã—</option>
              <option value="0.75">0.75Ã—</option>
              <option value="1" selected>1Ã—</option>
              <option value="1.25">1.25Ã—</option>
              <option value="1.5">1.5Ã—</option>
              <option value="2">2Ã—</option>
            </select>
            <span id="nowInfo" class="pill small">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</span>
          </div>
          <div id="thumbOut" class="small" style="color:var(--muted)"></div>
          <div class="small" style="color:var(--muted)">Ù†ØµÙŠØ­Ø©: Ø§Ø¶ØºØ· <span class="kbd">K</span> ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§ÙØŒ <span class="kbd">J</span> Ø±Ø¬ÙˆØ¹ 10 Ø«ØŒ <span class="kbd">L</span> ØªÙ‚Ø¯Ù… 10 Ø«.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="offline" class="offline" hidden>Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</div>

<script>
/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
const $ = sel => document.querySelector(sel);
const showToast = (msg, ok=true) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.12)';
  t.style.color = ok ? '#d1fae5' : '#fecaca';
  t.style.borderColor = ok ? 'rgba(16,185,129,.45)' : 'rgba(239,68,68,.4)';
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 3000);
};

/* ========= Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ø§Ø³Ù… Yotyosr ========= */
function generateIcon(size=192){
  const c = $('#appIconCanvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  const g = ctx.createLinearGradient(0,0,size,size);
  g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#22d3ee');
  ctx.fillStyle = g; ctx.fillRect(0,0,size,size);

  // Ù„Ù…Ø³Ø© Ù…ÙˆØ¬ÙŠØ©
  ctx.strokeStyle = 'rgba(255,255,255,.6)';
  ctx.lineWidth = Math.max(2, size*0.02);
  for(let i=0;i<4;i++){
    ctx.beginPath();
    for(let x=0; x<=size; x+=size/40){
      const y = size*0.25 + i*size*0.15 + Math.sin(x/size*Math.PI*2 + i)*size*0.06;
      if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  // Ø´Ø¹Ø§Ø± Ø­Ø±Ù Y Ø¨Ø´ÙƒÙ„ Ù…Ø«Ù„Ø« ØªØ´ØºÙŠÙ„
  ctx.fillStyle='rgba(255,255,255,.95)';
  ctx.shadowColor='rgba(0,0,0,.3)'; ctx.shadowBlur=size*0.06;
  // Ù…Ø«Ù„Ø« ØªØ´ØºÙŠÙ„
  ctx.beginPath();
  const tri = size*0.45;
  ctx.moveTo(size*0.38, size*0.32);
  ctx.lineTo(size*0.38, size*0.68);
  ctx.lineTo(size*0.72, size*0.50);
  ctx.closePath(); ctx.fill();
  // Ø­Ø±Ù Y ØµØºÙŠØ± Ø£Ø³ÙÙ„
  ctx.shadowBlur=0;
  ctx.font = `bold ${Math.floor(size*0.28)}px "Segoe UI",sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('Y', size*0.24, size*0.62);

  return c.toDataURL('image/png');
}

/* ========= Ø­Ù‚Ù† Manifest ========= */
function injectManifest(){
  const icon192 = generateIcon(192);
  const icon512 = generateIcon(512);
  $('#appIconLink').href = icon192;
  const manifest = {
    name: "Yotyosr â€” Ù…Ø´ØºÙ‘Ù„ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯-Ù…Ù„Ù",
    short_name: "Yotyosr",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0ea5e9",
    description: "Ù…ÙƒØªØ¨Ø© ÙÙŠØ¯ÙŠÙˆ Ù…Ø­Ù„ÙŠØ© ÙˆØ±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ© Ù…Ø¹ ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø© ÙˆØ¨Ø­Ø« ÙˆÙ‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„ØŒ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†.",
    icons: [
      { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ],
    shortcuts: [
      { name: "Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ", url: "./?add=1", description: "ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©" },
      { name: "ØªØ´ØºÙŠÙ„ Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ", url: "./?resume=1", description: "Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„" }
    ]
  };
  const manifestStr = JSON.stringify(manifest);
  const manifestDataUrl = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(manifestStr)));
  $('#manifestLink').href = manifestDataUrl;
  showToast('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª âœ…');
}

/* ========= Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ========= */
function updateOnline(){ $('#offline').hidden = navigator.onLine; }
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);

/* ========= Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ========= */
let library = [];
let currentIndex = -1;
const LS_KEY = 'yotyosr.library';
const LS_LAST = 'yotyosr.last';

function loadLibrary(){
  try{
    library = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  }catch{ library = []; }
}
function saveLibrary(){
  localStorage.setItem(LS_KEY, JSON.stringify(library));
}
function setLast(index){
  currentIndex = index;
  localStorage.setItem(LS_LAST, String(index));
}
function getLast(){
  const v = localStorage.getItem(LS_LAST);
  return v ? Number(v) : -1;
}

/* ========= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© ========= */
function renderList(){
  const q = ($('#searchInp').value || '').trim().toLowerCase();
  const list = $('#list'); list.innerHTML = '';
  library
    .map((item, idx)=> ({item, idx}))
    .filter(({item})=> item.title.toLowerCase().includes(q))
    .forEach(({item, idx})=>{
      const card = document.createElement('div'); card.className='card';
      const th = document.createElement('img'); th.className='thumb'; th.alt='thumbnail';
      th.src = item.thumb || '';
      th.style.objectFit = 'cover';
      const meta = document.createElement('div'); meta.className='meta';
      const t = document.createElement('div'); t.className='title'; t.textContent = item.title;
      const s = document.createElement('div'); s.className='sub'; s.textContent = item.duration ? `Ø§Ù„Ù…Ø¯Ø©: ${item.duration}` : 'â€”';
      meta.appendChild(t); meta.appendChild(s);
      card.appendChild(th); card.appendChild(meta);

      card.addEventListener('click', ()=> playIndex(idx));
      list.appendChild(card);
    });
}

/* ========= ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ========= */
const player = $('#player');
function playIndex(idx){
  if(idx<0 || idx>=library.length) return;
  const it = library[idx];
  player.src = it.url;
  player.playbackRate = Number($('#speedSel').value) || 1;
  player.play().catch(()=>{ /* Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙØ§Ø¹Ù„ */ });
  setLast(idx);
  updateNowInfo();
}
function updateNowInfo(){
  const idx = currentIndex = getLast();
  if(idx>=0 && library[idx]){
    $('#nowInfo').textContent = `ÙŠØ´ØºÙ‘Ù„: ${library[idx].title}`;
  }else{
    $('#nowInfo').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„';
  }
}
$('#speedSel').addEventListener('change', ()=>{ player.playbackRate = Number($('#speedSel').value)||1; });
$('#prevBtn').addEventListener('click', ()=> playIndex(Math.max(0, getLast()-1)));
$('#nextBtn').addEventListener('click', ()=> playIndex(Math.min(library.length-1, getLast()+1)));
$('#pipBtn').addEventListener('click', async ()=>{
  if(document.pictureInPictureEnabled && !player.disablePictureInPicture){
    try{ await player.requestPictureInPicture(); }catch(e){ showToast('ØªØ¹Ø°Ù‘Ø± PiP', false); }
  }else showToast('PiP ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', false);
});

/* ========= Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± ========= */
function promptAddUrl(){
  const url = prompt('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø± (MP4/HLS Ø£Ùˆ Ù…Ù„Ù Blob URL):');
  if(!url) return;
  const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:') || 'ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  const id = Date.now();
  const item = { id, title, url, thumb:'', duration:'' };
  library.unshift(item);
  saveLibrary(); renderList(); showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…');
}
$('#addUrlBtn').addEventListener('click', promptAddUrl);
$('#searchInp').addEventListener('input', renderList);
$('#clearSearchBtn').addEventListener('click', ()=>{ $('#searchInp').value=''; renderList(); });

/* ========= ØµÙˆØ± Ù…ØµØºÙ‘Ø±Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ========= */
async function generateThumb(){
  const idx = getLast();
  if(idx<0 || !library[idx]){ showToast('Ø´ØºÙ‘Ù„ ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ø§Ù‹', false); return; }
  try{
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙÙ‘Ø± Ø¥Ø·Ø§Ø±
    if(player.readyState < 2){ await player.play().catch(()=>{}); await new Promise(r=> setTimeout(r, 300)); player.pause(); }
    const cn = document.createElement('canvas'); cn.width = 320; cn.height = 180;
    const ctx = cn.getContext('2d');
    ctx.drawImage(player, 0, 0, cn.width, cn.height);
    const url = cn.toDataURL('image/jpeg', 0.8);
    library[idx].thumb = url;
    saveLibrary(); renderList();
    $('#thumbOut').innerHTML = 'ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºÙ‘Ø±Ø©. <a href="'+url+'" target="_blank" style="color:#7dd3fc">ÙØªØ­</a>';
    showToast('ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø© Ø¬Ø§Ù‡Ø²Ø© âœ…');
  }catch(e){
    console.error(e); showToast('ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø©', false);
  }
}
$('#thumbBtn').addEventListener('click', generateThumb);

/* ========= Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± ========= */
$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(library, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url; a.download = `yotyosr-library-${ts}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 3000);
  showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨Ø© âœ…');
});
$('#importBtn').addEventListener('click', async ()=>{
  try{
    const [f] = await window.showOpenFilePicker({types:[{description:'JSON', accept:{'application/json':['.json']}}]});
    const file = await f.getFile();
    const text = await file.text();
    const arr = JSON.parse(text);
    if(Array.isArray(arr)){
      library = arr.filter(x=> x && x.url);
      saveLibrary(); renderList();
      showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…');
    }else showToast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', false);
  }catch(e){ showToast('Ø£ÙÙ„ØºÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', false); }
});

/* ========= Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù…Ù„ÙØ§Øª ÙÙŠØ¯ÙŠÙˆ ========= */
const drop = $('#dropZone');
['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor='#22d3ee'; }));
['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor='rgba(255,255,255,.18)'; }));
drop.addEventListener('drop', e=>{
  const files = [...e.dataTransfer.files].filter(f=> f.type.startsWith('video/'));
  if(!files.length){ showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª ÙÙŠØ¯ÙŠÙˆ', false); return; }
  files.forEach(f=>{
    const url = URL.createObjectURL(f); // Ø¬Ù„Ø³Ø© Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
    const title = f.name;
    library.unshift({ id: Date.now()+Math.random(), title, url, thumb:'', duration:'' });
  });
  saveLibrary(); renderList(); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ âœ…');
});

/* ========= Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ========= */
player.addEventListener('loadedmetadata', ()=>{
  const idx = getLast();
  if(idx>=0 && library[idx]){
    const d = player.duration;
    const hh = Math.floor(d/3600);
    const mm = Math.floor((d%3600)/60).toString().padStart(2,'0');
    const ss = Math.floor(d%60).toString().padStart(2,'0');
    library[idx].duration = hh>0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
    saveLibrary(); renderList();
  }
});

/* ========= Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ========= */
document.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if(k==='k'){ if(player.paused) player.play(); else player.pause(); }
  if(k==='j'){ player.currentTime = Math.max(0, player.currentTime - 10); }
  if(k==='l'){ player.currentTime = Math.min(player.duration||player.currentTime+10, player.currentTime + 10); }
});

/* ========= ØªØ«Ø¨ÙŠØª PWA ========= */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e;
  $('#installBtn').disabled = false;
  showToast('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª â€” Ø§Ø¶ØºØ· Ø²Ø± ØªØ«Ø¨ÙŠØª');
});
$('#installBtn').addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('#installBtn').disabled = true;
  showToast(outcome==='accepted' ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ğŸ‰' : 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª');
});

/* ========= Service Worker ÙˆØ§Ø­Ø¯-Ù…Ù„Ù ========= */
async function registerSW(){
  const swCode = `
    const CACHE = 'yotyosr-cache-v1';
    const CORE = ['.'];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      const req = e.request;
      const url = new URL(req.url);
      // Cache-first Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·Ø› Ù„Ø§ Ù†Ø®Ø²Ù‘Ù† ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙƒØ¨ÙŠØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
      if(req.method==='GET' && url.origin===self.location.origin){
        e.respondWith(
          caches.match(req).then(res=>{
            return res || fetch(req).then(network=>{
              const copy = network.clone();
              // ØªØ¬Ù†Ù‘Ø¨ ØªØ®Ø²ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
              if(!copy.headers.get('content-type')?.startsWith('video/')){
                caches.open(CACHE).then(c=>c.put(req, copy)).catch(()=>{});
              }
              return network;
            }).catch(()=> caches.match('.'));
          })
        );
      }
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  try{
    await navigator.serviceWorker.register(swUrl, { scope: '.' });
    showToast('Service Worker Ø¬Ø§Ù‡Ø² ğŸ›¡ï¸');
    setTimeout(()=> URL.revokeObjectURL(swUrl), 4000);
  }catch(err){
    console.error(err); showToast('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Service Worker', false);
  }
}

/* ========= ØªÙ‡ÙŠØ¦Ø© ========= */
function init(){
  injectManifest();
  updateOnline();
  loadLibrary();
  renderList();
  registerSW();
  updateNowInfo();

  const params = new URLSearchParams(location.search);
  if(params.has('add')) promptAddUrl();
  if(params.has('resume')){
    const idx = getLast();
    if(idx>=0) playIndex(idx);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
