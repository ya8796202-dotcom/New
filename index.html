<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ â€” PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù</title>
<meta name="theme-color" content="#0ea5e9" />

<style>
  :root{
    --bg:#0b1220;
    --glass:rgba(255,255,255,.08);
    --glass-2:rgba(255,255,255,.14);
    --text:#e6f2ff;
    --muted:#a9c2d9;
    --accent:#0ea5e9;
    --accent-2:#22d3ee;
    --danger:#ef4444;
    --ok:#10b981;
    --shadow: 0 20px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{
    background: radial-gradient(1000px 700px at 10% 10%, #0f1b33 0%, #0b1220 45%, #070c16 100%);
    color:var(--text); font-family: "Segoe UI", Tahoma, sans-serif; margin:0; min-height:100%;
  }
  .container{
    max-width:1000px; margin:0 auto; padding:24px;
  }
  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    padding:10px 14px; border-radius:12px; background:var(--glass); backdrop-filter: blur(12px);
    box-shadow: var(--shadow);
  }
  .brand canvas{ width:40px; height:40px; border-radius:10px; }
  .brand .titles{ display:flex; flex-direction:column; }
  .brand .titles .name{ font-weight:700; letter-spacing:.3px}
  .brand .titles .sub{ color:var(--muted); font-size:.9rem }
  .actions{ display:flex; gap:10px; flex-wrap:wrap }
  button{
    appearance:none; border:none; color:#fff; font-weight:600;
    padding:10px 14px; border-radius:12px; cursor:pointer;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: var(--shadow);
  }
  button.secondary{
    background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
    color:var(--text);
  }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .card{
    margin-top:16px; border-radius:var(--radius); background:var(--glass);
    backdrop-filter: blur(18px); box-shadow: var(--shadow); overflow:hidden;
  }
  .canvas-wrap{ position:relative; }
  #quoteCanvas{ width:100%; height:auto; display:block; }
  .toolbar{
    display:flex; gap:8px; padding:12px; border-top:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  }
  .toolbar .group{ display:flex; gap:8px; flex-wrap:wrap }
  .pill{
    padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.08); color:var(--muted); font-size:.9rem
  }
  .input, select{
    padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
    background:rgba(255,255,255,.06); color:var(--text);
  }
  .toast{
    position:fixed; right:20px; bottom:20px; background:rgba(16,185,129,.15);
    color:#d1fae5; border:1px solid rgba(16,185,129,.45);
    padding:10px 14px; border-radius:12px; backdrop-filter: blur(10px); box-shadow: var(--shadow);
    transform: translateY(20px); opacity:0; pointer-events:none; transition: .35s ease;
  }
  .toast.show{ transform: translateY(0); opacity:1; pointer-events:auto }
  .offline{
    position:fixed; left:20px; bottom:20px; background:rgba(239,68,68,.12);
    color:#fecaca; border:1px solid rgba(239,68,68,.4);
    padding:8px 12px; border-radius:10px; backdrop-filter: blur(10px);
  }
  .shortcuts{ margin-top:10px; color:var(--muted); font-size:.9rem }
  a.link{ color:#7dd3fc; text-decoration:none }
  .hint{ color:var(--muted); margin-top:8px }
</style>

<!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ…Ø§Ù†ÙŠÙØ³Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø£Ø¯Ù†Ø§Ù‡ -->
<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />

</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <canvas id="appIconCanvas" width="128" height="128" aria-hidden="true"></canvas>
      <div class="titles">
        <div class="name">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³</div>
        <div class="sub">PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù | ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† | ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±</div>
      </div>
    </div>
    <div class="actions">
      <button id="installBtn" title="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" disabled>ØªØ«Ø¨ÙŠØª</button>
      <button id="newQuoteBtn">Ø§Ù‚ØªØ¨Ø§Ø³ Ø¬Ø¯ÙŠØ¯</button>
      <button id="downloadBtn" class="secondary">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
    </div>
  </header>

  <div class="card">
    <div class="canvas-wrap">
      <canvas id="quoteCanvas" width="1200" height="630" aria-label="ØµÙˆØ±Ø© Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³"></canvas>
    </div>
    <div class="toolbar">
      <div class="group">
        <span class="pill">Ù†Ù…Ø· Ø§Ù„Ø®Ù„ÙÙŠØ©:</span>
        <select id="bgStyle">
          <option value="gradient">ØªØ¯Ø±Ø¬ Ø²Ø¬Ø§Ø¬ÙŠ</option>
          <option value="mesh">Ø´Ø¨ÙƒØ© Ù„ÙˆÙ†ÙŠØ©</option>
          <option value="solid">Ù„ÙˆÙ† Ø«Ø§Ø¨Øª</option>
        </select>
      </div>
      <div class="group">
        <span class="pill">Ø§Ù„Ø­Ø¬Ù…:</span>
        <select id="sizeSel">
          <option value="1200x630">1200Ã—630 (Social)</option>
          <option value="1024x1024">1024Ã—1024</option>
          <option value="1080x1920">1080Ã—1920 (Story)</option>
        </select>
      </div>
      <div class="group">
        <span class="pill">Ø®Ø·:</span>
        <select id="fontSel">
          <option value="system">System UI</option>
          <option value="serif">Serif</option>
          <option value="mono">Monospace</option>
        </select>
      </div>
    </div>
  </div>

  <div class="shortcuts">
    Ø§Ø®ØªØµØ§Ø±Ø§Øª PWA: ÙØªØ­ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø³Ø±Ø¹Ø©ØŒ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ ÙˆØ¶Ø¹ ØºØ§Ù…Ù‚ Ø§ÙØªØ±Ø§Ø¶ÙŠ. Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø³ØªØ¬Ø¯Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.
  </div>
  <div class="hint">Ù†ØµÙŠØ­Ø©: ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø©. Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙÙˆÙ„Ù‘Ø¯Ø© Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© ğŸ‘Œ</div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="offline" class="offline" hidden>Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù† â€” Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</div>

<script>
/* ========= Ø£Ø¯ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© ========= */
const $ = sel => document.querySelector(sel);
const showToast = (msg, ok=true) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.12)';
  t.style.color = ok ? '#d1fae5' : '#fecaca';
  t.style.borderColor = ok ? 'rgba(16,185,129,.45)' : 'rgba(239,68,68,.4)';
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 3000);
};

/* ========= ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Canvas -> DataURL) ========= */
function generateIcon(size=192){
  const c = $('#appIconCanvas');
  c.width = size; c.height = size;
  const ctx = c.getContext('2d');

  // Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø© Ø²Ø¬Ø§Ø¬ÙŠØ©
  const g = ctx.createLinearGradient(0,0,size,size);
  g.addColorStop(0, '#0ea5e9');
  g.addColorStop(1, '#22d3ee');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,size,size);

  // Ø¯ÙˆØ§Ø¦Ø± Ø¨Ø±Ø§Ù‚Ø©
  for(let i=0;i<6;i++){
    const r = Math.random()*size*0.18 + size*0.08;
    const x = Math.random()*size;
    const y = Math.random()*size;
    const g2 = ctx.createRadialGradient(x,y,0,x,y,r);
    g2.addColorStop(0, 'rgba(255,255,255,0.35)');
    g2.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = g2;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }

  // Ø­Ø±Ù Ø²Ø®Ø±ÙÙŠ
  ctx.fillStyle = 'rgba(255,255,255,.95)';
  ctx.font = `${Math.floor(size*0.5)}px serif`;
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.shadowColor = 'rgba(0,0,0,.3)'; ctx.shadowBlur = size*0.06;
  ctx.fillText('Ù‚', size/2, size/2);

  return c.toDataURL('image/png');
}

/* ========= Ø­Ù‚Ù† Ø§Ù„Ù€ favicon ÙˆØ§Ù„Ù€ manifest Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© ========= */
async function injectManifest(){
  const icon192 = generateIcon(192);
  const icon512 = generateIcon(512);

  // favicon
  const iconLink = $('#appIconLink');
  iconLink.href = icon192;

  // manifest ÙƒÙ€ data:URL
  const manifest = {
    name: "Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ â€” ÙˆØ§Ø­Ø¯-Ù…Ù„Ù",
    short_name: "Ø§Ù‚ØªØ¨Ø§Ø³",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0ea5e9",
    description: "ØªØ·Ø¨ÙŠÙ‚ PWA Ø²Ø¬Ø§Ø¬ÙŠ ÙŠÙˆÙ„Ù‘Ø¯ Ø§Ù‚ØªØ¨Ø§Ø³Ø§ØªØŒ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª.",
    icons: [
      { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ],
    shortcuts: [
      { name: "Ø§Ù‚ØªØ¨Ø§Ø³ Ø¬Ø¯ÙŠØ¯", url: "./?new=1", description: "ØªÙˆÙ„ÙŠØ¯ Ø§Ù‚ØªØ¨Ø§Ø³ Ø¬Ø¯ÙŠØ¯" },
      { name: "ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©", url: "./?dl=1", description: "Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØµÙˆØ±Ø©" }
    ]
  };
  const manifestStr = JSON.stringify(manifest);
  const manifestDataUrl = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(manifestStr)));
  const manifestLink = $('#manifestLink');
  manifestLink.href = manifestDataUrl;

  showToast('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª âœ…');
}

/* ========= Ù…ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³Ø§Øª ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª ========= */
const QUOTES = [
  "Ø§Ø¨Ø¯Ø£ Ø­ÙŠØ« Ø£Ù†ØªØŒ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ù„Ø¯ÙŠÙƒØŒ ÙˆØ§ÙØ¹Ù„ Ù…Ø§ ØªØ³ØªØ·ÙŠØ¹.",
  "Ø§Ù„ØªØ±ÙƒÙŠØ² ÙŠØ³Ø¨Ù‚ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø².",
  "ØªØ¹Ù„Ù‘Ù… Ø¨Ø³Ø±Ø¹Ø©ØŒ ÙˆÙƒØ±Ù‘Ø± Ø¨Ø°ÙƒØ§Ø¡.",
  "Ø§Ù„ÙˆØ¶ÙˆØ­ Ù‚ÙˆØ©.",
  "Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© ØªØªÙÙˆÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø§Ù„.",
  "Ø§Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙ‡Ù… Ø­Ù‚Ù‹Ø§."
];

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

function setCanvasSize(w,h){
  const cn = $('#quoteCanvas');
  cn.width = w; cn.height = h;
}

function drawBackground(ctx, w, h, style){
  if(style==='solid'){
    ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,w,h);
  }else if(style==='mesh'){
    const grad = ctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0, '#0ea5e9'); grad.addColorStop(1, '#22d3ee');
    ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
    for(let i=0;i<8;i++){
      const rx = Math.random()*w, ry = Math.random()*h;
      const r = Math.random()*Math.min(w,h)*0.25;
      const g = ctx.createRadialGradient(rx,ry,0,rx,ry,r);
      g.addColorStop(0,'rgba(255,255,255,.15)');
      g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(rx,ry,r,0,Math.PI*2); ctx.fill();
    }
  }else{
    const grad = ctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0, '#0f1b33'); grad.addColorStop(1, '#0b1220');
    ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);
    // Ø·Ø¨Ù‚Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© Ù„Ø·ÙŠÙØ©
    for(let i=0;i<6;i++){
      const gx = Math.random()*w, gy = Math.random()*h;
      const r = Math.random()*Math.min(w,h)*0.18 + Math.min(w,h)*0.08;
      const g = ctx.createRadialGradient(gx,gy,0,gx,gy,r);
      g.addColorStop(0,'rgba(255,255,255,.10)');
      g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(gx,gy,r,0,Math.PI*2); ctx.fill();
    }
  }
}

function drawQuote(){
  const cn = $('#quoteCanvas');
  const ctx = cn.getContext('2d');
  const style = $('#bgStyle').value;
  const fontSel = $('#fontSel').value;

  drawBackground(ctx, cn.width, cn.height, style);

  const pad = Math.round(cn.width * 0.08);
  const maxWidth = cn.width - pad*2;

  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  const fontBase = fontSel==='serif' ? 'Georgia, serif' :
                   fontSel==='mono' ? 'Consolas, monospace' :
                   'system-ui, -apple-system, Segoe UI, Roboto, Ubuntu';
  const titleSize = Math.round(cn.height*0.08);
  const bodySize = Math.round(cn.height*0.06);

  // Ø¹Ù†ÙˆØ§Ù† ØµØºÙŠØ±
  ctx.font = `bold ${Math.round(cn.height*0.035)}px ${fontBase}`;
  ctx.fillStyle = 'rgba(255,255,255,.75)';
  ctx.fillText('Ø¨Ø·Ø§Ù‚Ø© Ø§Ù‚ØªØ¨Ø§Ø³', cn.width/2, Math.round(cn.height*0.12));

  // Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³
  const quote = pick(QUOTES);
  ctx.font = `bold ${bodySize}px ${fontBase}`;
  ctx.fillStyle = '#ffffff';
  ctx.shadowColor = 'rgba(0,0,0,.35)';
  ctx.shadowBlur = Math.round(cn.height*0.012);

  // Ø§Ù„ØªÙØ§Ù Ø¨Ø³ÙŠØ· Ù„Ù„Ù†Øµ
  function wrapText(text, x, y, maxW, lineHeight){
    const words = text.split(' ');
    let line = '';
    const lines = [];
    for(let w of words){
      const test = line ? line + ' ' + w : w;
      const metrics = ctx.measureText(test);
      if(metrics.width > maxW && line){
        lines.push(line); line = w;
      }else line = test;
    }
    if(line) lines.push(line);
    lines.forEach((l,i)=>{
      ctx.fillText(l, x, y + i*lineHeight);
    });
  }
  wrapText(quote, cn.width/2, cn.height/2, maxWidth, Math.round(bodySize*1.25));

  // ØªÙˆÙ‚ÙŠØ¹/Ù‡Ø§Ù…Ø´
  ctx.shadowBlur = 0;
  ctx.font = `600 ${Math.round(cn.height*0.032)}px ${fontBase}`;
  ctx.fillStyle = 'rgba(255,255,255,.75)';
  ctx.fillText('â€” ÙŠÙˆÙ…Ùƒ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¨Ø¯Ø£ Ø¨ÙƒÙ„Ù…Ø©', cn.width/2, cn.height - Math.round(cn.height*0.10));
}

/* ========= ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ========= */
function downloadImage(){
  const cn = $('#quoteCanvas');
  const url = cn.toDataURL('image/png');
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url; a.download = `quote-${ts}.png`;
  document.body.appendChild(a); a.click(); a.remove();
  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© âœ…');
}

/* ========= Ø­Ø¬Ù… Ø§Ù„Ù‚_canvas ========= */
function applySize(){
  const val = $('#sizeSel').value; // Ù…Ø«Ù„ 1200x630
  const [w,h] = val.split('x').map(Number);
  setCanvasSize(w,h);
  drawQuote();
}

/* ========= ØªØ«Ø¨ÙŠØª PWA ========= */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  $('#installBtn').disabled = false;
  showToast('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª â€” Ø§Ø¶ØºØ· Ø²Ø± ØªØ«Ø¨ÙŠØª');
});
$('#installBtn').addEventListener('click', async ()=>{
  if(!deferredPrompt){ return }
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('#installBtn').disabled = true;
  showToast(outcome==='accepted' ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ğŸ‰' : 'Ø£Ù„ØºÙŠØª Ø§Ù„ØªØ«Ø¨ÙŠØª');
});

/* ========= Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ ========= */
function updateOnline(){
  const off = $('#offline');
  if(navigator.onLine){ off.hidden = true; } else { off.hidden = false; }
}
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);

/* ========= Service Worker ÙˆØ§Ø­Ø¯-Ù…Ù„Ù ========= */
async function registerSW(){
  const swCode = `
    const CACHE = 'quote-pwa-cache-v1';
    const CORE = ['.']; // Ø§Ù„ØµÙØ­Ø© Ù†ÙØ³Ù‡Ø§
    self.addEventListener('install', (e)=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate', (e)=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', (e)=>{
      const req = e.request;
      const url = new URL(req.url);
      // Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©: Try cache first for same-origin GETs
      if(req.method==='GET' && url.origin===self.location.origin){
        e.respondWith(
          caches.match(req).then(res=>{
            return res || fetch(req).then(network=>{
              const copy = network.clone();
              caches.open(CACHE).then(c=>c.put(req, copy));
              return network;
            }).catch(()=> caches.match('.'));
          })
        );
      }
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  try{
    const reg = await navigator.serviceWorker.register(swUrl, { scope: '.' });
    showToast('Service Worker Ø¬Ø§Ù‡Ø² ğŸ›¡ï¸');
    // ØªÙ†Ø¸ÙŠÙ URL blob Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    setTimeout(()=> URL.revokeObjectURL(swUrl), 4000);
  }catch(err){
    console.error(err);
    showToast('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Service Worker', false);
  }
}

/* ========= ØªÙ‡ÙŠØ¦Ø© ========= */
function init(){
  injectManifest();
  applySize();
  drawQuote();
  updateOnline();
  registerSW();

  $('#newQuoteBtn').addEventListener('click', drawQuote);
  $('#downloadBtn').addEventListener('click', downloadImage);
  $('#bgStyle').addEventListener('change', drawQuote);
  $('#fontSel').addEventListener('change', drawQuote);
  $('#sizeSel').addEventListener('change', applySize);

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù€ manifest
  const params = new URLSearchParams(location.search);
  if(params.has('new')) drawQuote();
  if(params.has('dl')) downloadImage();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
