<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Yotyosr â€” ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨ÙŠÙˆØªÙŠÙˆØ¨ | PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù</title>
<meta name="theme-color" content="#0ea5e9" />

<style>
  :root{
    --bg:#0f0f0f; --header:#0f0f0f; --sidebar:#0f0f0f; --card:#181818;
    --text:#fff; --muted:#aaaaaa; --border:#303030; --accent:#0ea5e9; --accent2:#22d3ee;
    --shadow:0 12px 24px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0; min-height:100%; background:var(--bg); color:var(--text); font-family:Roboto, "Segoe UI", Tahoma, sans-serif}
  a{color:inherit; text-decoration:none}
  .app{display:grid; grid-template-columns: 240px 1fr; grid-template-rows: 56px 1fr; grid-template-areas:
      "header header" "sidebar main"; height:100vh}

  /* Header */
  .header{grid-area:header; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:var(--header); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
  .header-left{display:flex; align-items:center; gap:12px}
  .menu-btn{width:40px; height:40px; display:grid; place-items:center; border-radius:999px; cursor:pointer}
  .logo{display:flex; align-items:center; gap:8px; font-weight:700}
  .logo .play{width:26px; height:18px; background:#fff; clip-path: polygon(0 0, 100% 50%, 0 100%); }
  .logo .name{letter-spacing:.2px}
  .search{display:flex; align-items:center; gap:0; flex:1; max-width:700px}
  .search input{
    flex:1; height:40px; background:#121212; border:1px solid var(--border); color:#fff; padding:0 12px; border-radius:20px 0 0 20px; outline:none;
  }
  .search button{
    height:40px; width:64px; border:1px solid var(--border); border-left:none; border-radius:0 20px 20px 0; background:#222; color:#fff; cursor:pointer;
  }
  .header-right{display:flex; align-items:center; gap:10px}
  .header-right .btn{width:40px; height:40px; display:grid; place-items:center; border-radius:999px; background:#222; border:1px solid var(--border); cursor:pointer}

  /* Sidebar */
  .sidebar{grid-area:sidebar; background:var(--sidebar); border-right:1px solid var(--border); padding:8px 0; overflow:auto}
  .nav-item{
    display:flex; align-items:center; gap:12px; padding:10px 16px; border-radius:10px; cursor:pointer; color:#e6e6e6;
  }
  .nav-item:hover{background:#1f1f1f}
  .nav-item .ico{width:22px; height:22px; background:#e6e6e6; opacity:.9; border-radius:4px}
  .section-title{padding:8px 16px; color:#bbb; font-size:.9rem; margin-top:6px}

  /* Main */
  .main{grid-area:main; overflow:auto}
  .chips{display:flex; gap:8px; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:56px; background:var(--bg); z-index:5}
  .chip{padding:8px 12px; background:#272727; border:1px solid var(--border); border-radius:999px; color:#ddd; cursor:pointer; white-space:nowrap}
  .chip.active{background:#fff; color:#000; border-color:#fff}
  .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; padding:16px}
  .card{display:flex; flex-direction:column; gap:8px}
  .thumb{width:100%; aspect-ratio:16/9; background:#111; border-radius:12px; overflow:hidden}
  .row{display:flex; gap:10px}
  .avatar{width:36px; height:36px; border-radius:999px; background:#333; flex-shrink:0}
  .meta{display:flex; flex-direction:column; gap:2px}
  .title{font-weight:500; line-height:1.3}
  .sub{color:#aaa; font-size:.9rem}

  /* Watch page */
  .watch{display:grid; grid-template-columns: 1fr 420px; gap:16px; padding:16px}
  .player-wrap{background:#000; border-radius:12px; overflow:hidden}
  .player-wrap video{width:100%; height:auto; display:block}
  .watch-title{font-size:1.2rem; font-weight:600; margin-top:8px}
  .watch-actions{display:flex; gap:8px; margin:8px 0}
  .btn{padding:8px 12px; border-radius:999px; background:#272727; border:1px solid var(--border); color:#fff; cursor:pointer}
  .btn.secondary{background:#1f1f1f}
  .watch-meta{color:#aaa; font-size:.9rem}
  .suggestions{display:flex; flex-direction:column; gap:12px}
  .sugg-card{display:flex; gap:10px; cursor:pointer}
  .sugg-thumb{width:180px; aspect-ratio:16/9; background:#111; border-radius:8px; overflow:hidden; flex-shrink:0}
  .sugg-meta{display:flex; flex-direction:column; gap:2px}
  .divider{height:1px; background:var(--border); margin:12px 0}

  /* Toast + offline + install */
  .toast{position:fixed; right:20px; bottom:20px; background:rgba(16,185,129,.15); color:#d1fae5; border:1px solid rgba(16,185,129,.45);
    padding:10px 14px; border-radius:12px; backdrop-filter: blur(10px); box-shadow: var(--shadow);
    transform: translateY(20px); opacity:0; pointer-events:none; transition:.35s ease;}
  .toast.show{transform:translateY(0); opacity:1; pointer-events:auto}
  .offline{position:fixed; left:20px; bottom:20px; background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.4); padding:8px 12px; border-radius:10px}
  .install-btn{margin-right:8px; padding:8px 12px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border:none; color:#fff; cursor:pointer}
</style>

<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="menu-btn" id="toggleSidebar" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
        <span style="width:18px;height:2px;background:#e6e6e6;display:block;margin:3px 0"></span>
        <span style="width:18px;height:2px;background:#e6e6e6;display:block;margin:3px 0"></span>
        <span style="width:18px;height:2px;background:#e6e6e6;display:block;margin:3px 0"></span>
      </div>
      <div class="logo">
        <div class="play"></div>
        <div class="name">Yotyosr</div>
      </div>
    </div>

    <div class="search">
      <input id="searchInp" type="text" placeholder="Ø§Ø¨Ø­Ø«" />
      <button id="searchBtn">Ø¨Ø­Ø«</button>
    </div>

    <div class="header-right">
      <button id="installBtn" class="install-btn" disabled>ØªØ«Ø¨ÙŠØª</button>
      <div class="btn" title="Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">ğŸ””</div>
      <div class="btn" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">ğŸ‘¤</div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="nav-item" data-chip="Ø§Ù„ÙƒÙ„"><div class="ico"></div> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav-item" data-chip="Ù…ÙˆØ³ÙŠÙ‚Ù‰"><div class="ico"></div> Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
    <div class="nav-item" data-chip="Ø£Ù„Ø¹Ø§Ø¨"><div class="ico"></div> Ø£Ù„Ø¹Ø§Ø¨</div>
    <div class="nav-item" data-chip="ØªØ¹Ù„ÙŠÙ…ÙŠ"><div class="ico"></div> ØªØ¹Ù„ÙŠÙ…ÙŠ</div>
    <div class="nav-item" data-chip="Ø±ÙŠØ§Ø¶Ø©"><div class="ico"></div> Ø±ÙŠØ§Ø¶Ø©</div>
    <div class="section-title">Ø§Ù„Ù…ÙƒØªØ¨Ø©</div>
    <div class="nav-item" id="addUrlBtn"><div class="ico"></div> Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ</div>
    <div class="nav-item" id="importBtn"><div class="ico"></div> Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</div>
    <div class="nav-item" id="exportBtn"><div class="ico"></div> ØªØµØ¯ÙŠØ± JSON</div>
    <div class="section-title">Ø£Ø¯ÙˆØ§Øª</div>
    <div class="nav-item" id="pipNav"><div class="ico"></div> ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="chips" id="chips">
      <div class="chip active" data-chip="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</div>
      <div class="chip" data-chip="Ù…ÙˆØ³ÙŠÙ‚Ù‰">Ù…ÙˆØ³ÙŠÙ‚Ù‰</div>
      <div class="chip" data-chip="Ø£Ù„Ø¹Ø§Ø¨">Ø£Ù„Ø¹Ø§Ø¨</div>
      <div class="chip" data-chip="ØªØ¹Ù„ÙŠÙ…ÙŠ">ØªØ¹Ù„ÙŠÙ…ÙŠ</div>
      <div class="chip" data-chip="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</div>
    </div>

    <div id="homeView">
      <div class="grid" id="grid"></div>
      <div class="divider"></div>
      <div class="grid" id="grid2"></div>
    </div>

    <div id="watchView" style="display:none">
      <div class="watch">
        <div>
          <div class="player-wrap"><video id="player" controls playsinline></video></div>
          <div class="watch-title" id="watchTitle">â€”</div>
          <div class="watch-actions">
            <button class="btn" id="likeBtn">ğŸ‘ Ø£Ø¹Ø¬Ø¨Ù†ÙŠ</button>
            <button class="btn" id="shareBtn">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
            <button class="btn" id="speedBtn">âš¡ Ø§Ù„Ø³Ø±Ø¹Ø©</button>
            <button class="btn" id="pipBtn">ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</button>
          </div>
          <div class="watch-meta" id="watchMeta">â€”</div>
          <div class="divider"></div>
          <div class="watch-meta">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØºÙŠØ± Ù…ÙØ¹Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.</div>
        </div>
        <div>
          <div class="suggestions" id="suggestions"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="offline" class="offline" hidden>Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</div>

<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />
<canvas id="appIconCanvas" width="128" height="128" style="position:fixed;left:-9999px;top:-9999px"></canvas>

<script>
/* ========= Ø£Ø¯ÙˆØ§Øª ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const showToast = (msg, ok=true) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.12)';
  t.style.color = ok ? '#d1fae5' : '#fecaca';
  t.style.borderColor = ok ? 'rgba(16,185,129,.45)' : 'rgba(239,68,68,.4)';
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 3000);
};

/* ========= Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¨Ø±ÙˆØ­ Ù…Ø´ØºÙ‘Ù„ ÙÙŠØ¯ÙŠÙˆ ========= */
function generateIcon(size=192){
  const c = $('#appIconCanvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#0ea5e9';
  ctx.fillRect(0,0,size,size);
  // Ù‚Ø±Øµ ØºØ§Ù…Ù‚
  ctx.fillStyle = '#0b1220'; ctx.beginPath(); ctx.arc(size/2,size/2,size*0.45,0,Math.PI*2); ctx.fill();
  // Ù…Ø«Ù„Ø« ØªØ´ØºÙŠÙ„ Ø£Ø¨ÙŠØ¶
  ctx.fillStyle = '#fff'; ctx.beginPath();
  ctx.moveTo(size*0.45, size*0.35);
  ctx.lineTo(size*0.45, size*0.65);
  ctx.lineTo(size*0.70, size*0.50);
  ctx.closePath(); ctx.fill();
  return c.toDataURL('image/png');
}
function injectManifest(){
  const icon192 = generateIcon(192);
  const icon512 = generateIcon(512);
  $('#appIconLink').href = icon192;
  const manifest = {
    name: "Yotyosr â€” ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨ÙŠÙˆØªÙŠÙˆØ¨",
    short_name: "Yotyosr",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0f0f0f",
    theme_color: "#0ea5e9",
    description: "Ù…Ø´ØºÙ‘Ù„ ÙˆÙ…ÙƒØªØ¨Ø© ÙÙŠØ¯ÙŠÙˆ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¬Ø¯Ù‹Ø§ Ø¨ÙŠÙˆØªÙŠÙˆØ¨ØŒ ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª.",
    icons: [
      { src: icon192, sizes: "192x192", type: "image/png", purpose:"any maskable" },
      { src: icon512, sizes: "512x512", type: "image/png", purpose:"any maskable" }
    ],
    shortcuts: [
      { name:"Ø¨Ø­Ø«", url:"./?focus=search", description:"ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«" },
      { name:"Ø§Ø³ØªØ¦Ù†Ø§Ù", url:"./?resume=1", description:"ØªØ´ØºÙŠÙ„ Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ" }
    ]
  };
  const dataUrl = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(JSON.stringify(manifest))));
  $('#manifestLink').href = dataUrl;
}

/* ========= Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ========= */
function updateOnline(){ $('#offline').hidden = navigator.onLine; }
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);

/* ========= Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨Ø© ========= */
let library = []; // {id,title,channel,views,age,url,thumb,category}
const LS_KEY = 'yotyosr.library';
const LS_LAST = 'yotyosr.last';
function loadLibrary(){
  try{ library = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ library=[]; }
  if(!library.length){
    // Ø¹ÙŠÙ†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø±ÙˆØ§Ø¨Ø· ÙØ¹Ù„ÙŠØ© â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· MP4 Ù„Ø§Ø­Ù‚Ù‹Ø§
    library = Array.from({length:12}).map((_,i)=>({
      id: Date.now()+i,
      title: `ÙÙŠØ¯ÙŠÙˆ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø±Ù‚Ù… ${i+1}`,
      channel: `Ù‚Ù†Ø§Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©`,
      views: `${(Math.random()*100|0)} Ø£Ù„Ù Ù…Ø´Ø§Ù‡Ø¯Ø©`,
      age: `${(Math.random()*10|0)} Ø£ÙŠØ§Ù…`,
      url: '',
      thumb: '',
      category: ['Ø§Ù„ÙƒÙ„','Ù…ÙˆØ³ÙŠÙ‚Ù‰','Ø£Ù„Ø¹Ø§Ø¨','ØªØ¹Ù„ÙŠÙ…ÙŠ','Ø±ÙŠØ§Ø¶Ø©'][i%5]
    }));
    saveLibrary();
  }
}
function saveLibrary(){ localStorage.setItem(LS_KEY, JSON.stringify(library)); }
function setLast(index){ localStorage.setItem(LS_LAST, String(index)); }
function getLast(){ const v = localStorage.getItem(LS_LAST); return v?Number(v):-1; }

/* ========= ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø© Ù…ØµØºÙ‘Ø±Ø© ÙˆÙ‡Ù…ÙŠØ© ========= */
function makeThumb(w=1280,h=720,text='Yotyosr'){
  const cn = document.createElement('canvas'); cn.width=w; cn.height=h;
  const ctx = cn.getContext('2d');
  const g = ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,'#202020'); g.addColorStop(1,'#404040');
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 72px "Segoe UI", Roboto';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(text, w/2, h/2);
  // Ù…Ø«Ù„Ø« ØªØ´ØºÙŠÙ„
  ctx.fillStyle = '#0ea5e9'; ctx.beginPath();
  ctx.moveTo(w/2 - 60, h/2 - 40);
  ctx.lineTo(w/2 - 60, h/2 + 40);
  ctx.lineTo(w/2 + 20, h/2);
  ctx.closePath(); ctx.fill();
  return cn.toDataURL('image/jpeg', 0.85);
}

/* ========= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ========= */
function renderHome(){
  $('#homeView').style.display='block';
  $('#watchView').style.display='none';
  const q = ($('#searchInp').value||'').trim().toLowerCase();
  const activeChip = [...$$('.chip')].find(c=> c.classList.contains('active'))?.dataset.chip || 'Ø§Ù„ÙƒÙ„';
  const grid = $('#grid'); grid.innerHTML='';
  const grid2 = $('#grid2'); grid2.innerHTML='';

  const items = library
    .filter(it=> (activeChip==='Ø§Ù„ÙƒÙ„' || it.category===activeChip))
    .filter(it=> it.title.toLowerCase().includes(q));

  items.forEach((it,idx)=>{
    if(!it.thumb) it.thumb = makeThumb(1280,720, it.title);
    const card = document.createElement('div'); card.className='card';
    const th = document.createElement('img'); th.className='thumb'; th.src = it.thumb; th.alt = it.title; th.loading='lazy';
    const row = document.createElement('div'); row.className='row';
    const avatar = document.createElement('div'); avatar.className='avatar';
    const meta = document.createElement('div'); meta.className='meta';
    const title = document.createElement('div'); title.className='title'; title.textContent = it.title;
    const sub = document.createElement('div'); sub.className='sub'; sub.textContent = `${it.channel} â€¢ ${it.views} â€¢ ${it.age}`;
    meta.appendChild(title); meta.appendChild(sub);
    row.appendChild(avatar); row.appendChild(meta);
    card.appendChild(th); card.appendChild(row);
    card.addEventListener('click', ()=> openWatch(it));
    (idx%2===0 ? grid : grid2).appendChild(card);
  });
}

/* ========= ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ========= */
const player = $('#player');
function openWatch(it){
  $('#homeView').style.display='none';
  $('#watchView').style.display='block';
  $('#watchTitle').textContent = it.title;
  $('#watchMeta').textContent = `${it.channel} â€¢ ${it.views} â€¢ ${it.age}`;
  if(it.url){ player.src = it.url; player.play().catch(()=>{}); }
  else { player.removeAttribute('src'); player.load(); showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ â€” Ø£Ø¶Ù ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ', false); }

  const sugg = $('#suggestions'); sugg.innerHTML='';
  library.slice(0,8).forEach(s=>{
    const sc = document.createElement('div'); sc.className='sugg-card';
    const th = document.createElement('img'); th.className='sugg-thumb'; th.src = s.thumb || makeThumb(640,360,s.title);
    const m = document.createElement('div'); m.className='sugg-meta';
    const tt = document.createElement('div'); tt.textContent = s.title; tt.style.fontWeight='500';
    const sb = document.createElement('div'); sb.textContent = `${s.channel} â€¢ ${s.views}`; sb.style.color='#aaa';
    m.appendChild(tt); m.appendChild(sb);
    sc.appendChild(th); sc.appendChild(m);
    sc.addEventListener('click', ()=> openWatch(s));
    sugg.appendChild(sc);
  });

  setLast(library.indexOf(it));
}

/* ========= Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ========= */
$('#searchBtn').addEventListener('click', renderHome);
$('#searchInp').addEventListener('input', renderHome);
$('#toggleSidebar').addEventListener('click', ()=>{
  const sb = $('#sidebar');
  sb.style.display = (sb.style.display==='none' ? 'block' : 'none');
});
$('#chips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  $$('.chip').forEach(c=> c.classList.remove('active'));
  chip.classList.add('active');
  renderHome();
});
$$('.nav-item').forEach(el=>{
  el.addEventListener('click', ()=>{
    const chip = el.dataset.chip;
    if(chip){
      $$('.chip').forEach(c=> c.classList.remove('active'));
      const targetChip = [...$$('.chip')].find(c=> c.dataset.chip===chip);
      if(targetChip){ targetChip.classList.add('active'); renderHome(); }
    }
  });
});

/* ========= Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· / Ø§Ø³ØªÙŠØ±Ø§Ø¯ / ØªØµØ¯ÙŠØ± ========= */
function promptAddUrl(){
  const url = prompt('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø± (MP4/HLS):');
  if(!url) return;
  const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:') || 'ÙÙŠØ¯ÙŠÙˆ';
  const item = {
    id: Date.now(), title, channel:'Ù‚Ù†Ø§ØªÙƒ', views:'0 Ù…Ø´Ø§Ù‡Ø¯Ø©', age:'Ø§Ù„ÙŠÙˆÙ…', url, thumb: makeThumb(1280,720,title), category: 'Ø§Ù„ÙƒÙ„'
  };
  library.unshift(item); saveLibrary(); renderHome(); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ âœ…');
}
$('#addUrlBtn').addEventListener('click', promptAddUrl);
$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(library, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url; a.download = `yotyosr-library-${ts}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 3000);
  showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨Ø© âœ…');
});
$('#importBtn').addEventListener('click', async ()=>{
  try{
    const [f] = await window.showOpenFilePicker({types:[{description:'JSON', accept:{'application/json':['.json']}}]});
    const file = await f.getFile(); const text = await file.text(); const arr = JSON.parse(text);
    if(Array.isArray(arr)){ library = arr; saveLibrary(); renderHome(); showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…'); }
    else showToast('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­', false);
  }catch(e){ showToast('Ø£ÙÙ„ØºÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', false); }
});

/* ========= ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ========= */
$('#pipNav').addEventListener('click', async ()=>{
  if(document.pictureInPictureEnabled && !player.disablePictureInPicture){ try{ await player.requestPictureInPicture(); }catch{} }
  else showToast('PiP ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', false);
});

/* ========= Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ========= */
document.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if(k==='k'){ if(player.paused) player.play(); else player.pause(); }
  if(k==='j'){ player.currentTime = Math.max(0, player.currentTime - 10); }
  if(k==='l'){ player.currentTime = Math.min(player.duration||player.currentTime+10, player.currentTime + 10); }
});

/* ========= ØªØ«Ø¨ÙŠØª PWA ========= */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt=e; $('#installBtn').disabled=false; showToast('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª â€” Ø§Ø¶ØºØ· Ø²Ø± ØªØ«Ø¨ÙŠØª');
});
$('#installBtn').addEventListener('click', async ()=>{
  if(!deferredPrompt) return; deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice; deferredPrompt=null; $('#installBtn').disabled=true;
  showToast(outcome==='accepted' ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ğŸ‰' : 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª');
});

/* ========= Service Worker ÙˆØ§Ø­Ø¯-Ù…Ù„Ù ========= */
async function registerSW(){
  const swCode = `
    const CACHE='yotyosr-cache-v1';
    const CORE=['.'];
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch',e=>{
      const req=e.request; const url=new URL(req.url);
      if(req.method==='GET' && url.origin===self.location.origin){
        e.respondWith(
          caches.match(req).then(res=>{
            return res || fetch(req).then(net=>{
              const copy=net.clone();
              if(!(copy.headers.get('content-type')||'').startsWith('video/')){
                caches.open(CACHE).then(c=>c.put(req, copy)).catch(()=>{});
              }
              return net;
            }).catch(()=> caches.match('.'));
          })
        );
      }
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  try{
    await navigator.serviceWorker.register(swUrl,{scope:'.'});
    showToast('Service Worker Ø¬Ø§Ù‡Ø² ğŸ›¡ï¸'); setTimeout(()=> URL.revokeObjectURL(swUrl), 4000);
  }catch(e){ console.error(e); showToast('ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Service Worker', false); }
}

/* ========= ØªÙ‡ÙŠØ¦Ø© ========= */
function init(){
  injectManifest();
  updateOnline();
  loadLibrary();
  renderHome();
  registerSW();

  const params = new URLSearchParams(location.search);
  if(params.get('focus')==='search'){ $('#searchInp').focus(); }
  if(params.has('resume')){ const idx = getLast(); if(idx>=0) openWatch(library[idx]); }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
