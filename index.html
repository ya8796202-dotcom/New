<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>محرر فيديو زجاجي — ملف واحد</title>
<style>
  :root{
    --bg: #0a0f1f;
    --fg: #eaf2ff;
    --card: rgba(255,255,255,0.08);
    --border: rgba(255,255,255,0.16);
    --accent: #4ca7ff;
    --accent2:#7bd7ff;
    --glass: blur(18px) saturate(120%) contrast(105%);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#e9f1ff; --fg:#0c1730; --card: rgba(255,255,255,0.55); --border: rgba(16,50,90,0.12); }
  }
  *{ box-sizing:border-box }
  body{
    margin:0; font-family: ui-rounded, system-ui, "Segoe UI", Arial;
    background:
      radial-gradient(1200px 600px at 8% 12%, #0c1e44, transparent 60%),
      radial-gradient(1000px 500px at 92% 0%, #0a314f, transparent 50%),
      linear-gradient(180deg, var(--bg), var(--bg));
    color: var(--fg);
    min-height:100vh;
  }
  header{
    padding:18px 12px; text-align:center; position:sticky; top:0; z-index:10;
    background:linear-gradient(90deg, #4ca7ff22, #7bd7ff12);
    border-bottom:1px solid #ffffff1a;
  }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .container{ max-width:1100px; margin:22px auto; padding:0 14px }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  .card{
    background: var(--card);
    backdrop-filter: var(--glass);
    -webkit-backdrop-filter: var(--glass);
    border:1px solid var(--border);
    border-radius:16px; padding:16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.22);
  }
  label{ font-size:13px; color:#cfe5ff; margin-bottom:6px; display:block }
  input[type="file"], select, input[type="number"], input[type="range"], input[type="text"], button{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #bfe1ff33;
    background:linear-gradient(180deg,#091427,#0c1830);
    color:var(--fg); outline:none;
  }
  input[type="range"]{ accent-color: var(--accent) }
  button{
    cursor:pointer; font-weight:700; letter-spacing:.3px;
    background:linear-gradient(180deg, var(--accent), var(--accent2));
    color:#071120; border-color:#4ca7ff; box-shadow: 0 6px 18px #4ca7ff44;
  }
  button.secondary{
    background:linear-gradient(180deg,#14223f,#1b2a4f); color:#d7e7ff; border-color:#2a3f66;
  }
  button:disabled{ opacity:.55; cursor:not-allowed }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
  .help{ font-size:12px; color:#aac8e9 }
  .preview{ display:flex; gap:14px; flex-wrap:wrap; align-items:flex-start }
  video, canvas{
    width:100%; max-height:420px; background:#000; border-radius:16px; border:1px solid #28466c66;
  }
  .badge{ display:inline-block; background:#0f2a4f99; border:1px solid #4ca7ff55; color:#bde1ff;
          padding:4px 8px; border-radius:999px; font-size:12px }
  .stack{ display:flex; gap:10px; flex-wrap:wrap }
  .small{ font-size:12px; color:#a9c8e9 }
  .out{ font-size:12px; background:#0c172f; border:1px dashed #3a5a86; padding:8px; border-radius:12px }
  .pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
         background:#123155aa; border:1px solid #4ca7ff33; color:#cfe5ff; font-size:12px; text-decoration:none }
  .thumbs img{ width:120px; border-radius:12px; border:1px solid #28466c66 }
  footer{ text-align:center; padding:14px; color:#9fbfe6; font-size:13px }
</style>
</head>
<body>
<header>
  <h1>محرر فيديو زجاجي — إضافة موسيقى وصور وتأثيرات وتصدير WebM</h1>
  <div class="small">جاهز للتثبيت كـ PWA و للرفع على GitHub Pages — ملف واحد فقط</div>
</header>

<div class="container">

  <div class="card">
    <div class="row">
      <div>
        <label>اختيار فيديو</label>
        <input id="videoFile" type="file" accept="video/*">
      </div>
      <div>
        <label>اختيار موسيقى</label>
        <input id="audioFile" type="file" accept="audio/*">
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>كتم صوت الفيديو الأصلي</label>
        <select id="muteOriginal">
          <option value="yes">نعم</option>
          <option value="no" selected>لا</option>
        </select>
      </div>
      <div>
        <label>مستوى الموسيقى الخارجية</label>
        <input id="audioGain" type="range" min="0" max="2" step="0.05" value="1">
        <div class="help">0 صامت — 2 مضاعف</div>
      </div>
      <div>
        <label>سرعة التشغيل</label>
        <select id="rate">
          <option>0.75</option>
          <option selected>1</option>
          <option>1.25</option>
          <option>1.5</option>
          <option>2</option>
        </select>
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>بداية القص (ثانية)</label>
        <input id="startSec" type="number" min="0" value="0">
      </div>
      <div>
        <label>نهاية القص (ثانية)</label>
        <input id="endSec" type="number" min="0" placeholder="مثال: 15">
      </div>
      <div>
        <label>انتقال الفيديو</label>
        <select id="videoTransition">
          <option value="none">بدون</option>
          <option value="fade">تلاشي (Fade)</option>
          <option value="flash">وميض خفيف</option>
        </select>
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>فلتر الفيديو</label>
        <select id="filter">
          <option value="none">بدون</option>
          <option value="grayscale(100%)">أبيض وأسود</option>
          <option value="sepia(80%)">سيبيا</option>
          <option value="brightness(1.25)">سطوع أعلى</option>
          <option value="contrast(1.25)">تباين أعلى</option>
          <option value="saturate(1.3)">تشبيع أعلى</option>
          <option value="invert(100%)">عكس الألوان</option>
          <option value="blur(2px)">تمويه خفيف</option>
        </select>
      </div>
      <div>
        <label>شدة التوهج التلوين</label>
        <input id="filterExtra" type="range" min="0" max="1" step="0.01" value="0">
        <div class="help">يُضاف فوق الفلتر المختار (Tint/Glow)</div>
      </div>
      <div>
        <label>لون التوهج</label>
        <input id="glowColor" type="text" value="#4ca7ff">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>إضافة صورة Overlay</label>
        <input id="imageFile" type="file" accept="image/*">
        <div class="help">تظهر فوق الفيديو — يمكنك تحريكها وحركتها</div>
      </div>
      <div>
        <label>نص Overlay</label>
        <input id="overlayText" type="text" placeholder="اكتب نصًا يظهر فوق الفيديو">
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>حركة الصورة</label>
        <select id="imageAnim">
          <option value="none">بدون</option>
          <option value="slide">انزلاق</option>
          <option value="float">تعويم بسيط</option>
          <option value="spin">دوران خفيف</option>
          <option value="zoom">تكبير تدريجي</option>
        </select>
      </div>
      <div>
        <label>موضع الصورة X</label>
        <input id="imgX" type="number" value="40">
      </div>
      <div>
        <label>موضع الصورة Y</label>
        <input id="imgY" type="number" value="40">
      </div>
    </div>

    <div class="stack" style="margin-top:12px">
      <button id="snapshot" class="secondary">التقاط صورة</button>
      <button id="export">بدء التصدير</button>
      <a id="download" class="pill" style="display:none" download="output.webm">⬇️ تنزيل الفيديو</a>
      <span class="badge" id="status">جاهز</span>
    </div>
  </div>

  <div class="card preview">
    <div style="flex:1;min-width:280px">
      <label>معاينة الفيديو</label>
      <video id="video" controls playsinline></video>
    </div>
    <div style="flex:1;min-width:280px">
      <label>لوحة المعالجة (Canvas)</label>
      <canvas id="canvas"></canvas>
      <div class="out" id="log"></div>
      <div class="thumbs stack" id="thumbs"></div>
    </div>
  </div>

  <div class="card">
    <div class="small">
      حدود المتصفح: الإخراج WebM عبر MediaRecorder (VP8/VP9). للمخرجات MP4 أو مونتاج متعدد المقاطع استخدم لاحقًا ffmpeg.wasm.
    </div>
  </div>

</div>

<footer>نسخة ملف واحد جاهزة للرفع على GitHub Pages • يمكنك استبدال الأيقونة المدمجة بصورة شعارك لاحقًا</footer>

<script>
(function(){
  const els = {
    videoFile: document.getElementById('videoFile'),
    audioFile: document.getElementById('audioFile'),
    imageFile: document.getElementById('imageFile'),
    startSec: document.getElementById('startSec'),
    endSec: document.getElementById('endSec'),
    muteOriginal: document.getElementById('muteOriginal'),
    filter: document.getElementById('filter'),
    filterExtra: document.getElementById('filterExtra'),
    glowColor: document.getElementById('glowColor'),
    rate: document.getElementById('rate'),
    audioGain: document.getElementById('audioGain'),
    overlayText: document.getElementById('overlayText'),
    imageAnim: document.getElementById('imageAnim'),
    imgX: document.getElementById('imgX'),
    imgY: document.getElementById('imgY'),
    video: document.getElementById('video'),
    canvas: document.getElementById('canvas'),
    snapshot: document.getElementById('snapshot'),
    exportBtn: document.getElementById('export'),
    downloadBtn: document.getElementById('download'),
    status: document.getElementById('status'),
    log: document.getElementById('log'),
    thumbs: document.getElementById('thumbs'),
  };

  let audio = null, audioCtx=null, gainNode=null, audioSource=null;
  let overlayImg = null;
  let recorder = null, recordedBlobs=[], exporting=false;

  function log(msg){ const p=document.createElement('div'); p.textContent=msg; els.log.appendChild(p); }
  function setStatus(s){ els.status.textContent=s; }

  // Load video
  els.videoFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    const url = URL.createObjectURL(file);
    els.video.src = url; els.video.load();
    els.video.onloadedmetadata = ()=>{
      els.canvas.width = els.video.videoWidth || 1280;
      els.canvas.height = els.video.videoHeight || 720;
      setStatus('فيديو جاهز: ' + Math.round(els.video.duration) + ' ثانية');
    };
  });

  // Load audio
  els.audioFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    if(audio){ audio.pause(); audio=null; }
    const url = URL.createObjectURL(file);
    audio = new Audio(url); audio.crossOrigin='anonymous'; audio.preload='auto';
    log('تم تحميل الموسيقى');
  });

  // Load overlay image
  els.imageFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    const url = URL.createObjectURL(file);
    overlayImg = new Image(); overlayImg.src = url;
    overlayImg.onload = ()=> log('تم تحميل الصورة كـ Overlay');
  });

  // Snapshot
  els.snapshot.addEventListener('click', ()=>{
    if(!els.video.src) return;
    const ctx = els.canvas.getContext('2d');
    drawCompositeFrame(ctx, els.video, els.canvas, currentTime());
    els.canvas.toBlob((blob)=>{
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      els.thumbs.appendChild(img);
    }, 'image/png');
  });

  function currentTime(){ return els.video.currentTime || 0; }

  // Composite frame: video + filter + glow + overlays + transitions
  function drawCompositeFrame(ctx, video, canvas, t){
    const w=canvas.width, h=canvas.height;

    // Transition alpha (fade-in/out)
    const start=parseFloat(els.startSec?.value)||0;
    const end=parseFloat(els.endSec?.value)||video.duration;
    const dur=Math.max(0.001, end-start);
    const tr=document.getElementById('videoTransition').value;
    let alpha=1;
    if(tr==='fade'){
      const dIn = Math.min(1.5, Math.max(0.3, dur*0.1));
      const dOut= Math.min(1.5, Math.max(0.3, dur*0.12));
      const localT = Math.min(Math.max(t-start,0), dur);
      if(localT<dIn) alpha = localT/dIn;
      else if(localT>dur-dOut) alpha = Math.max(0, (dur-localT)/dOut);
    } else if(tr==='flash'){
      alpha = 1 - Math.max(0, 0.1*Math.sin((t-start)*10));
    }

    ctx.save();
    ctx.globalAlpha = alpha;

    // Base filter
    ctx.filter = els.filter.value==='none' ? 'none' : els.filter.value;

    // Draw video
    ctx.drawImage(video, 0, 0, w, h);
    ctx.restore();

    // Extra tint/glow overlay
    const extra = parseFloat(els.filterExtra.value)||0;
    if(extra>0){
      ctx.save();
      ctx.globalAlpha = extra*0.25;
      ctx.fillStyle = els.glowColor.value || '#4ca7ff';
      ctx.fillRect(0,0,w,h);
      ctx.restore();
    }

    // Image overlay with animation
    if(overlayImg){
      ctx.save();
      const baseX=parseFloat(els.imgX.value)||40;
      const baseY=parseFloat(els.imgY.value)||40;
      let x=baseX, y=baseY, scale=1, rot=0;

      const anim=els.imageAnim.value;
      if(anim==='slide'){ x = baseX + Math.sin(t*0.8)*40; }
      else if(anim==='float'){ y = baseY + Math.sin(t*1.2)*30; }
      else if(anim==='spin'){ rot = Math.sin(t*0.6)*0.15; }
      else if(anim==='zoom'){ scale = 1 + Math.sin(t*0.5)*0.08; }

      const ow = Math.min(w/3, overlayImg.width);
      const oh = ow * (overlayImg.height/overlayImg.width);
      ctx.translate(x+ow/2, y+oh/2);
      ctx.rotate(rot);
      ctx.scale(scale, scale);
      ctx.globalAlpha = 0.92;
      ctx.drawImage(overlayImg, -ow/2, -oh/2, ow, oh);
      ctx.restore();
    }

    // Text overlay
    const txt = els.overlayText.value.trim();
    if(txt){
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.font = Math.round(h*0.045)+'px "Segoe UI", Arial';
      ctx.fillStyle = '#ffffff';
      ctx.shadowColor = els.glowColor.value || '#4ca7ff';
      ctx.shadowBlur = 18;
      ctx.textAlign = 'center';
      ctx.fillText(txt, w/2, h-28);
      ctx.restore();
    }
  }

  // Export
  els.exportBtn.addEventListener('click', async ()=>{
    if(exporting) return;
    if(!els.video.src){ alert('حمّل فيديو أولاً'); return; }
    setStatus('بدء التصدير…'); exporting=true; recordedBlobs=[]; els.log.innerHTML='';

    const ctx = els.canvas.getContext('2d');
    const stream = els.canvas.captureStream(30);

    // Audio setup
    const addOriginal = (els.muteOriginal.value==='no');
    if(addOriginal){
      try{
        const vStream = els.video.captureStream();
        const vTracks = vStream.getAudioTracks();
        if(vTracks.length) stream.addTrack(vTracks[0]);
      }catch{}
      els.video.muted = false;
    } else {
      els.video.muted = true;
    }

    if(audio){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(els.audioGain.value)||1;
      audioSource = audioCtx.createMediaElementSource(audio);
      const dest = audioCtx.createMediaStreamDestination();
      audioSource.connect(gainNode).connect(dest);
      audioSource.connect(gainNode).connect(audioCtx.destination);
      const aTracks = dest.stream.getAudioTracks();
      if(aTracks.length) stream.addTrack(aTracks[0]);
    }

    // Recorder
    const opts = { mimeType: 'video/webm;codecs=vp9' };
    const finalOpts = MediaRecorder.isTypeSupported(opts.mimeType) ? opts : { mimeType:'video/webm;codecs=vp8' };
    recorder = new MediaRecorder(stream, finalOpts);
    recorder.ondataavailable = e=>{ if(e.data?.size) recordedBlobs.push(e.data); };
    recorder.onstop = ()=>{
      const blob = new Blob(recordedBlobs, {type: finalOpts.mimeType});
      const url = URL.createObjectURL(blob);
      els.downloadBtn.href = url;
      els.downloadBtn.style.display='inline-flex';
      setStatus('جاهز للتنزيل');
      log('الحجم: ' + Math.round(blob.size/1024) + ' KB');
      // Optional: small toast
      showToast('تم تجهيز الفيديو للتنزيل');
    };
    recorder.start(120);

    // Playback
    const rate = parseFloat(els.rate.value)||1;
    els.video.playbackRate = rate;
    if(audio){ audio.playbackRate = rate; audio.currentTime = 0; }

    const start = Math.max(0, parseFloat(els.startSec.value)||0);
    const end = parseFloat(els.endSec.value);
    const hasEnd = !isNaN(end) && end>start;

    els.video.currentTime = start;
    await els.video.play(); if(audio) await audio.play();

    const w=els.canvas.width, h=els.canvas.height;
    let stopReq=false;
    function loop(){
      if(stopReq) return;
      drawCompositeFrame(ctx, els.video, els.canvas, els.video.currentTime);
      const t=els.video.currentTime;
      if(hasEnd && t>=end){ stopReq=true; finish(); return; }
      requestAnimationFrame(loop);
    }
    loop();

    async function finish(){
      try{
        els.video.pause(); if(audio) audio.pause();
        recorder.stop(); exporting=false; setStatus('اكتمل التصدير');
      }catch(err){
        log('خطأ: '+err.message); exporting=false; setStatus('فشل التصدير');
      }
    }
  });

  // Live filter preview
  els.filter.addEventListener('change', ()=>{ els.canvas.style.filter = els.filter.value; });
  els.audioGain.addEventListener('input', ()=>{ if(gainNode) gainNode.gain.value = parseFloat(els.audioGain.value)||1; });

  // Simple toast
  function showToast(text){
    const t = document.createElement('div');
    t.textContent = text;
    Object.assign(t.style, {
      position:'fixed', left:'50%', transform:'translateX(-50%)', bottom:'24px',
      background:'#0b2038', color:'#dff3ff', padding:'10px 16px', borderRadius:'12px',
      boxShadow:'0 8px 24px rgba(0,0,0,0.4)', zIndex:9999, opacity:0, transition:'opacity .25s'
    });
    document.body.appendChild(t);
    requestAnimationFrame(()=> t.style.opacity = '1');
    setTimeout(()=> { t.style.opacity='0'; setTimeout(()=> t.remove(),300); }, 3000);
  }

  // PWA manifest & SW inline (icon + caching)
  if('serviceWorker' in navigator){
    // أيقونة مدمجة (Base64 PNG 192x192) — استبدلها لاحقًا لو حبيت
    const iconPng = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMwAAADMAQAAAABrRr0NAAAAC0lEQVR4nO3BMQEAAAgDINc/9EoYHcQhCk0AAAAASUVORK5CYII=';
    const manifest = {
      name: "Glass Video Editor",
      short_name: "GlassEdit",
      start_url: "./",
      display: "standalone",
      background_color: "#0a0f1f",
      theme_color: "#4ca7ff",
      icons: [{ src: iconPng, sizes: "192x192", type: "image/png" }]
    };
    const manBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const manUrl = URL.createObjectURL(manBlob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=manUrl; document.head.appendChild(link);

    const swCode = `
      const CACHE='glass-edit-v1';
      const CORE=['./'];
      self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE))); self.skipWaiting(); });
      self.addEventListener('activate',e=> self.clients.claim());
      self.addEventListener('fetch',e=>{
        e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{
          const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res;
        }).catch(()=> r)));
      });
    `;
    const swBlob = new Blob([swCode], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(()=>{});
  }
})();
</script>
</body>
</html>
