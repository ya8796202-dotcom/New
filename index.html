<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>محرر فيديو زجاجي — تصدير سريع وزر تنزيل</title>
<link rel="manifest" href="/manifest.json">
<style>
  :root{
    --bg:#0a0f1f; --fg:#eaf2ff; --card:rgba(255,255,255,0.08);
    --border:rgba(255,255,255,0.16); --accent:#4ca7ff; --accent2:#7bd7ff;
    --glass: blur(18px) saturate(120%) contrast(105%);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#e9f1ff; --fg:#0c1730; --card:rgba(255,255,255,0.55); --border:rgba(16,50,90,0.12); }
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-rounded, system-ui, "Segoe UI", Arial;
    background:
      radial-gradient(1200px 600px at 8% 12%, #0c1e44, transparent 60%),
      radial-gradient(1000px 500px at 92% 0%, #0a314f, transparent 50%),
      linear-gradient(180deg,var(--bg),var(--bg));
    color:var(--fg); min-height:100vh;
  }
  header{ padding:18px 12px; text-align:center; position:sticky; top:0; z-index:10;
    background:linear-gradient(90deg,#4ca7ff22,#7bd7ff12); border-bottom:1px solid #ffffff1a; }
  h1{ margin:0; font-size:20px; letter-spacing:.3px }
  .container{ max-width:1100px; margin:22px auto; padding:0 14px }
  .card{ background:var(--card); backdrop-filter:var(--glass); -webkit-backdrop-filter:var(--glass);
    border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,0.22); }
  label{ font-size:13px; color:#cfe5ff; margin-bottom:6px; display:block }
  input[type="file"], select, input[type="number"], input[type="range"], input[type="text"], button{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid #bfe1ff33;
    background:linear-gradient(180deg,#091427,#0c1830); color:var(--fg); outline:none;
  }
  input[type="range"]{ accent-color:var(--accent) }
  button{ cursor:pointer; font-weight:700; letter-spacing:.3px;
    background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#071120; border-color:#4ca7ff; box-shadow:0 6px 18px #4ca7ff44; }
  button.secondary{ background:linear-gradient(180deg,#14223f,#1b2a4f); color:#d7e7ff; border-color:#2a3f66; }
  button:disabled{ opacity:.55; cursor:not-allowed }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
  .help{ font-size:12px; color:#aac8e9 }
  video, canvas{ width:100%; max-height:420px; background:#000; border-radius:16px; border:1px solid #28466c66; }
  .badge{ display:inline-block; background:#0f2a4f99; border:1px solid #4ca7ff55; color:#bde1ff; padding:4px 8px; border-radius:999px; font-size:12px }
  .stack{ display:flex; gap:10px; flex-wrap:wrap }
  .small{ font-size:12px; color:#a9c8e9 }
  .out{ font-size:12px; background:#0c172f; border:1px dashed #3a5a86; padding:8px; border-radius:12px }
  .pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#123155aa; border:1px solid #4ca7ff33; color:#cfe5ff; font-size:12px; text-decoration:none }
  .thumbs img{ width:120px; border-radius:12px; border:1px solid #28466c66 }
  #installBtn{ display:none; padding:8px 12px; border-radius:10px; background:#2ea0ff; color:#041226; border:none; font-weight:700; cursor:pointer; }
  footer{ text-align:center; padding:14px; color:#9fbfe6; font-size:13px }
</style>
</head>
<body>
<header>
  <h1>محرر فيديو زجاجي — تصدير سريع وزر تنزيل</h1>
  <div class="small">تحسينات للأداء وزر تنزيل فعلي يظهر بعد التصدير</div>
</header>

<div class="container">

  <div class="card">
    <div class="row">
      <div>
        <label>اختيار فيديو</label>
        <input id="videoFile" type="file" accept="video/*">
      </div>
      <div>
        <label>اختيار موسيقى</label>
        <input id="audioFile" type="file" accept="audio/*">
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>كتم صوت الفيديو الأصلي</label>
        <select id="muteOriginal">
          <option value="yes">نعم</option>
          <option value="no" selected>لا</option>
        </select>
      </div>
      <div>
        <label>مستوى الموسيقى الخارجية</label>
        <input id="audioGain" type="range" min="0" max="2" step="0.05" value="1">
        <div class="help">0 صامت — 2 مضاعف</div>
      </div>
      <div>
        <label>سرعة التشغيل</label>
        <select id="rate">
          <option>0.75</option>
          <option selected>1</option>
          <option>1.25</option>
          <option>1.5</option>
          <option>2</option>
        </select>
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>بداية القص (ثانية)</label>
        <input id="startSec" type="number" min="0" value="0">
      </div>
      <div>
        <label>نهاية القص (ثانية)</label>
        <input id="endSec" type="number" min="0" placeholder="مثال: 15">
      </div>
      <div>
        <label>انتقال الفيديو</label>
        <select id="videoTransition">
          <option value="none">بدون</option>
          <option value="fade">تلاشي (Fade)</option>
          <option value="flash">وميض خفيف</option>
        </select>
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>فلتر الفيديو</label>
        <select id="filter">
          <option value="none">بدون</option>
          <option value="grayscale(100%)">أبيض وأسود</option>
          <option value="sepia(80%)">سيبيا</option>
          <option value="brightness(1.25)">سطوع أعلى</option>
          <option value="contrast(1.25)">تباين أعلى</option>
          <option value="saturate(1.3)">تشبيع أعلى</option>
          <option value="invert(100%)">عكس الألوان</option>
          <option value="blur(2px)">تمويه خفيف</option>
        </select>
      </div>
      <div>
        <label>جودة التصدير</label>
        <select id="quality">
          <option value="720" selected>720p (أسرع)</option>
          <option value="480">480p (أسرع جداً)</option>
          <option value="full">Full (أصلية)</option>
        </select>
      </div>
      <div>
        <label>FPS للتصدير</label>
        <select id="fps">
          <option>30</option>
          <option selected>24</option>
          <option>20</option>
        </select>
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>شدة التوهج/التلوين</label>
        <input id="filterExtra" type="range" min="0" max="1" step="0.01" value="0">
      </div>
      <div>
        <label>لون التوهج</label>
        <input id="glowColor" type="text" value="#4ca7ff">
      </div>
      <div>
        <label>bitsPerSecond (تقريبي)</label>
        <select id="bits">
          <option value="1500000" selected>1.5 Mbps (سريع وصغير)</option>
          <option value="2500000">2.5 Mbps (توازن)</option>
          <option value="4000000">4 Mbps (جودة أعلى)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>إضافة صورة Overlay</label>
        <input id="imageFile" type="file" accept="image/*">
        <div class="help">تظهر فوق الفيديو — يتم تحويلها إلى ImageBitmap للتسريع</div>
      </div>
      <div>
        <label>نص Overlay</label>
        <input id="overlayText" type="text" placeholder="اكتب نصًا يظهر فوق الفيديو">
      </div>
    </div>

    <div class="row-3" style="margin-top:10px">
      <div>
        <label>حركة الصورة</label>
        <select id="imageAnim">
          <option value="none">بدون</option>
          <option value="slide">انزلاق</option>
          <option value="float">تعويم</option>
          <option value="spin">دوران</option>
          <option value="zoom">تكبير</option>
        </select>
      </div>
      <div>
        <label>موضع الصورة X</label>
        <input id="imgX" type="number" value="40">
      </div>
      <div>
        <label>موضع الصورة Y</label>
        <input id="imgY" type="number" value="40">
      </div>
    </div>

    <div class="stack" style="margin-top:12px">
      <button id="snapshot" class="secondary">التقاط صورة</button>
      <button id="export">بدء التصدير</button>

      <!-- زر تنزيل حقيقي -->
      <button id="downloadBtn" class="pill" style="display:none" disabled>⬇️ تنزيل الفيديو</button>

      <button id="installBtn">تثبيت التطبيق</button>
      <span class="badge" id="status">جاهز</span>
    </div>
  </div>

  <div class="card preview" style="margin-top:14px">
    <div style="flex:1;min-width:280px">
      <label>معاينة الفيديو</label>
      <video id="video" controls playsinline></video>
    </div>
    <div style="flex:1;min-width:280px">
      <label>لوحة المعالجة (Canvas)</label>
      <canvas id="canvas"></canvas>
      <div class="out" id="log"></div>
      <div class="thumbs stack" id="thumbs"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="small">ملاحظة: التصدير ينتج WebM (VP8/VP9). لملفات MP4 استخدمي تحويل خارجي أو ffmpeg.wasm لاحقًا.</div>
  </div>

</div>

<footer>احفظ الملف باسم index.html وارفعه مع manifest.json و sw.js و أيقونات في جذر المستودع</footer>

<script>
(async function(){
  const els = {
    videoFile: document.getElementById('videoFile'),
    audioFile: document.getElementById('audioFile'),
    imageFile: document.getElementById('imageFile'),
    startSec: document.getElementById('startSec'),
    endSec: document.getElementById('endSec'),
    muteOriginal: document.getElementById('muteOriginal'),
    filter: document.getElementById('filter'),
    filterExtra: document.getElementById('filterExtra'),
    glowColor: document.getElementById('glowColor'),
    rate: document.getElementById('rate'),
    audioGain: document.getElementById('audioGain'),
    overlayText: document.getElementById('overlayText'),
    imageAnim: document.getElementById('imageAnim'),
    imgX: document.getElementById('imgX'),
    imgY: document.getElementById('imgY'),
    video: document.getElementById('video'),
    canvas: document.getElementById('canvas'),
    snapshot: document.getElementById('snapshot'),
    exportBtn: document.getElementById('export'),
    downloadBtn: document.getElementById('downloadBtn'),
    status: document.getElementById('status'),
    log: document.getElementById('log'),
    thumbs: document.getElementById('thumbs'),
    quality: document.getElementById('quality'),
    fps: document.getElementById('fps'),
    bits: document.getElementById('bits'),
    installBtn: document.getElementById('installBtn')
  };

  let audio = null, audioCtx=null, gainNode=null, audioSource=null;
  let overlayImg = null, overlayBitmap = null;
  let recorder = null, recordedBlobs=[], exporting=false;
  let lastOutputUrl = null;
  let deferredPrompt = null;

  function log(msg){ const p=document.createElement('div'); p.textContent=msg; els.log.appendChild(p); }
  function setStatus(s){ els.status.textContent = s; }

  // تحميل الفيديو
  els.videoFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    const url = URL.createObjectURL(file);
    els.video.src = url; els.video.load();
    els.video.onloadedmetadata = ()=>{
      els.canvas.width = els.video.videoWidth || 1280;
      els.canvas.height = els.video.videoHeight || 720;
      setStatus('فيديو جاهز: ' + Math.round(els.video.duration) + ' ثانية');
    };
  });

  // تحميل الصوت
  els.audioFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    if(audio){ audio.pause(); audio=null; }
    const url = URL.createObjectURL(file);
    audio = new Audio(url); audio.crossOrigin='anonymous'; audio.preload='auto';
    log('تم تحميل الموسيقى');
  });

  // تحميل صورة Overlay وتحويلها إلى ImageBitmap فوراً لتسريع الرسم
  els.imageFile.addEventListener('change', async e=>{
    const file = e.target.files?.[0]; if(!file) return;
    const url = URL.createObjectURL(file);
    overlayImg = new Image();
    overlayImg.src = url;
    overlayImg.onload = async ()=>{
      try{
        if('createImageBitmap' in window){
          overlayBitmap = await createImageBitmap(overlayImg);
          log('تم تحويل الصورة إلى ImageBitmap للتسريع');
        } else {
          overlayBitmap = null;
          log('createImageBitmap غير مدعوم، سيتم استخدام drawImage العادي');
        }
      }catch(err){
        overlayBitmap = null;
        log('خطأ في createImageBitmap، سيتم استخدام drawImage العادي');
      }
    };
  });

  // لقطة سريعة
  els.snapshot.addEventListener('click', ()=>{
    if(!els.video.src) return;
    const ctx = els.canvas.getContext('2d');
    drawCompositeFrame(ctx, els.video, els.canvas, els.video.currentTime);
    els.canvas.toBlob((blob)=>{
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      els.thumbs.appendChild(img);
    }, 'image/png');
  });

  // ضبط حجم canvas حسب الجودة
  function setCanvasSizeForQuality(q){
    const vW = els.video.videoWidth || 1280;
    const vH = els.video.videoHeight || 720;
    if(q === '720'){
      const scale = Math.min(1, 1280 / Math.max(vW, vH));
      els.canvas.width = Math.round(vW * scale);
      els.canvas.height = Math.round(vH * scale);
    } else if(q === '480'){
      const scale = Math.min(1, 854 / Math.max(vW, vH));
      els.canvas.width = Math.round(vW * scale);
      els.canvas.height = Math.round(vH * scale);
    } else {
      els.canvas.width = vW; els.canvas.height = vH;
    }
  }

  // رسم الإطار المركب (مبسط قدر الإمكان)
  function drawCompositeFrame(ctx, video, canvas, t){
    const w = canvas.width, h = canvas.height;
    const start = parseFloat(document.getElementById('startSec')?.value || 0) || 0;
    const end = parseFloat(document.getElementById('endSec')?.value || video.duration) || video.duration;
    const dur = Math.max(0.001, end - start);
    const tr = document.getElementById('videoTransition')?.value || 'none';
    let alpha = 1;
    if(tr === 'fade'){
      const dIn = Math.min(1.5, Math.max(0.3, dur*0.1));
      const dOut = Math.min(1.5, Math.max(0.3, dur*0.12));
      const localT = Math.min(Math.max(t - start, 0), dur);
      if(localT < dIn) alpha = localT / dIn;
      else if(localT > dur - dOut) alpha = Math.max(0, (dur - localT) / dOut);
    } else if(tr === 'flash'){
      alpha = 1 - Math.max(0, 0.1 * Math.sin((t - start) * 10));
    }

    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.filter = els.filter.value === 'none' ? 'none' : els.filter.value;
    // رسم الفيديو
    ctx.drawImage(video, 0, 0, w, h);
    ctx.restore();

    // تلوين خفيف
    const extra = parseFloat(els.filterExtra.value) || 0;
    if(extra > 0){
      ctx.save();
      ctx.globalAlpha = extra * 0.25;
      ctx.fillStyle = els.glowColor.value || '#4ca7ff';
      ctx.fillRect(0, 0, w, h);
      ctx.restore();
    }

    // رسم overlay باستخدام ImageBitmap إن وُجد
    if(overlayBitmap){
      ctx.save();
      const baseX = parseFloat(els.imgX.value) || 40;
      const baseY = parseFloat(els.imgY.value) || 40;
      let x = baseX, y = baseY, scale = 1, rot = 0;
      const anim = els.imageAnim.value;
      if(anim === 'slide'){ x = baseX + Math.sin(t * 0.8) * 40; }
      else if(anim === 'float'){ y = baseY + Math.sin(t * 1.2) * 30; }
      else if(anim === 'spin'){ rot = Math.sin(t * 0.6) * 0.15; }
      else if(anim === 'zoom'){ scale = 1 + Math.sin(t * 0.5) * 0.08; }
      const ow = Math.min(w / 3, overlayBitmap.width);
      const oh = ow * (overlayBitmap.height / overlayBitmap.width);
      ctx.translate(x + ow/2, y + oh/2);
      ctx.rotate(rot);
      ctx.scale(scale, scale);
      ctx.globalAlpha = 0.92;
      ctx.drawImage(overlayBitmap, -ow/2, -oh/2, ow, oh);
      ctx.restore();
    } else if(overlayImg){
      // fallback: drawImage العادي
      ctx.save();
      const baseX = parseFloat(els.imgX.value) || 40;
      const baseY = parseFloat(els.imgY.value) || 40;
      const ow = Math.min(w / 3, overlayImg.width);
      const oh = ow * (overlayImg.height / overlayImg.width);
      ctx.globalAlpha = 0.92;
      ctx.drawImage(overlayImg, baseX, baseY, ow, oh);
      ctx.restore();
    }

    // نص
    const txt = els.overlayText.value.trim();
    if(txt){
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.font = Math.round(h * 0.045) + 'px "Segoe UI", Arial';
      ctx.fillStyle = '#ffffff';
      ctx.shadowColor = els.glowColor.value || '#4ca7ff';
      ctx.shadowBlur = 18;
      ctx.textAlign = 'center';
      ctx.fillText(txt, w/2, h - 28);
      ctx.restore();
    }
  }

  // التصدير (محسّن)
  els.exportBtn.addEventListener('click', async ()=>{
    if(exporting) return;
    if(!els.video.src){ alert('حمّل فيديو أولاً'); return; }
    setStatus('بدء التصدير…'); exporting = true; recordedBlobs = []; els.log.innerHTML = '';

    // ضبط جودة ودقة
    setCanvasSizeForQuality(els.quality.value);
    const fps = parseInt(els.fps.value || '24', 10);
    const bitsPerSecond = parseInt(els.bits.value || '1500000', 10);

    const ctx = els.canvas.getContext('2d');

    // استخدم captureStream مع fps منخفض لتسريع
    const stream = els.canvas.captureStream(fps);

    // صوت الفيديو الأصلي (اختياري)
    const addOriginal = (els.muteOriginal.value === 'no');
    if(addOriginal){
      try{
        const vStream = els.video.captureStream();
        const vTracks = vStream.getAudioTracks();
        if(vTracks.length) stream.addTrack(vTracks[0]);
      }catch(e){}
      els.video.muted = false;
    } else {
      els.video.muted = true;
    }

    // صوت خارجي عبر WebAudio (مبسط)
    if(audio){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = parseFloat(els.audioGain.value) || 1;
        audioSource = audioCtx.createMediaElementSource(audio);
        const dest = audioCtx.createMediaStreamDestination();
        audioSource.connect(gainNode).connect(dest);
        audioSource.connect(gainNode).connect(audioCtx.destination);
        const aTracks = dest.stream.getAudioTracks();
        if(aTracks.length) stream.addTrack(aTracks[0]);
      }catch(e){
        log('تعذر إعداد WebAudio: ' + e.message);
      }
    }

    // إعداد MediaRecorder بخيارات سريعة (vp8 غالباً أسرع على بعض الأجهزة)
    const opts = { mimeType: 'video/webm;codecs=vp8', bitsPerSecond: bitsPerSecond };
    let finalOpts = opts;
    if(!MediaRecorder.isTypeSupported(opts.mimeType)){
      finalOpts = { mimeType: 'video/webm;codecs=vp9', bitsPerSecond: bitsPerSecond };
      if(!MediaRecorder.isTypeSupported(finalOpts.mimeType)) finalOpts = { mimeType: 'video/webm' };
    }

    try{
      recorder = new MediaRecorder(stream, finalOpts);
    }catch(err){
      recorder = new MediaRecorder(stream);
    }

    let totalBytes = 0;
    recorder.ondataavailable = e=>{
      if(e.data && e.data.size){
        recordedBlobs.push(e.data);
        totalBytes += e.data.size;
        setStatus('تسجيل... حجم مؤقت: ' + Math.round(totalBytes/1024) + ' KB');
      }
    };

    // استبدال onstop بمقطع موثوق يعرض زر التنزيل
    recorder.onstop = () => {
      try {
        const blob = new Blob(recordedBlobs, { type: finalOpts.mimeType || 'video/webm' });
        if (lastOutputUrl) {
          try { URL.revokeObjectURL(lastOutputUrl); } catch(e){}
          lastOutputUrl = null;
        }
        const url = URL.createObjectURL(blob);
        lastOutputUrl = url;

        // تفعيل زر التنزيل كزر حقيقي
        els.downloadBtn.disabled = false;
        els.downloadBtn.style.display = 'inline-flex';
        els.downloadBtn.textContent = '⬇️ تنزيل الفيديو';
        els.downloadBtn.dataset.blobUrl = url;

        setStatus('جاهز للتنزيل');
        log('الحجم النهائي: ' + Math.round(blob.size/1024) + ' KB');
        showToast('تم تجهيز الفيديو للتنزيل');
      } catch (err) {
        console.error('onstop error:', err);
        setStatus('خطأ أثناء تجهيز الملف');
        showToast('حدث خطأ أثناء تجهيز الملف');
      }
    };

    // ابدأ التسجيل مع timeslice أكبر لتقليل overhead
    recorder.start(500);

    // تشغيل ومزامنة
    const rate = parseFloat(els.rate.value) || 1;
    els.video.playbackRate = rate;
    if(audio){ audio.playbackRate = rate; audio.currentTime = 0; }

    const start = Math.max(0, parseFloat(document.getElementById('startSec')?.value || 0) || 0);
    const end = parseFloat(document.getElementById('endSec')?.value || NaN);
    const hasEnd = !isNaN(end) && end > start;

    els.video.currentTime = start;
    await els.video.play();
    if(audio) await audio.play();

    // استخدم requestVideoFrameCallback إن وُجد لمزامنة أسرع مع إطار الفيديو
    let stopReq = false;
    const useRVFC = typeof els.video.requestVideoFrameCallback === 'function';
    if(useRVFC){
      const rvfc = (now, metadata) => {
        if(stopReq) return;
        drawCompositeFrame(ctx, els.video, els.canvas, els.video.currentTime);
        const t = els.video.currentTime;
        if(hasEnd && t >= end){ stopReq = true; finish(); return; }
        try{ els.video.requestVideoFrameCallback(rvfc); }catch(e){ requestAnimationFrame(()=>rvfc(now, metadata)); }
      };
      try{ els.video.requestVideoFrameCallback(rvfc); }catch(e){ requestAnimationFrame(function loop(){ if(stopReq) return; drawCompositeFrame(ctx, els.video, els.canvas, els.video.currentTime); const t=els.video.currentTime; if(hasEnd && t>=end){ stopReq=true; finish(); return;} requestAnimationFrame(loop); }); }
    } else {
      // fallback إلى requestAnimationFrame
      function rafLoop(){
        if(stopReq) return;
        drawCompositeFrame(ctx, els.video, els.canvas, els.video.currentTime);
        const t = els.video.currentTime;
        if(hasEnd && t >= end){ stopReq = true; finish(); return; }
        requestAnimationFrame(rafLoop);
      }
      requestAnimationFrame(rafLoop);
    }

    async function finish(){
      try{
        els.video.pause(); if(audio) audio.pause();
        recorder.stop(); exporting = false; setStatus('اكتمل التصدير');
      }catch(err){
        log('خطأ أثناء الإيقاف: ' + err.message); exporting = false; setStatus('فشل التصدير');
      }
    }
  });

  // زر التنزيل: سلوك زر حقيقي يقوم بإنشاء رابط مؤقت وتحميله ثم تنظيف الذاكرة
  els.downloadBtn.addEventListener('click', (e)=>{
    const url = e.currentTarget.dataset.blobUrl;
    if(!url) {
      showToast('لا يوجد ملف جاهز للتنزيل');
      return;
    }
    const filename = 'edited-video.webm';
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    els.downloadBtn.disabled = true;
    setTimeout(()=> {
      try{ URL.revokeObjectURL(url); }catch{}
      if(lastOutputUrl === url) lastOutputUrl = null;
      els.downloadBtn.style.display = 'none';
      setStatus('تم التنزيل');
    }, 2500);
  });

  // معاينة فلتر مباشر
  els.filter.addEventListener('change', ()=>{ els.canvas.style.filter = els.filter.value; });
  els.audioGain.addEventListener('input', ()=>{ if(gainNode) gainNode.gain.value = parseFloat(els.audioGain.value)||1; });

  // Toast بسيط
  function showToast(text){
    const t = document.createElement('div');
    t.textContent = text;
    Object.assign(t.style, {
      position:'fixed', left:'50%', transform:'translateX(-50%)', bottom:'24px',
      background:'#0b2038', color:'#dff3ff', padding:'10px 16px', borderRadius:'12px',
      boxShadow:'0 8px 24px rgba(0,0,0,0.4)', zIndex:9999, opacity:0, transition:'opacity .25s'
    });
    document.body.appendChild(t);
    requestAnimationFrame(()=> t.style.opacity = '1');
    setTimeout(()=> { t.style.opacity='0'; setTimeout(()=> t.remove(),300); }, 3000);
  }

  // Install prompt handling
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    els.installBtn.style.display = 'inline-block';
  });

  els.installBtn.addEventListener('click', async () => {
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    deferredPrompt = null;
    els.installBtn.style.display = 'none';
    if(choice && choice.outcome === 'accepted') showToast('تم تثبيت التطبيق');
  });

  // تسجيل Service Worker من الجذر (sw.js يجب أن يكون في root)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').then(()=> {
      console.log('Service Worker registered from /sw.js');
    }).catch(()=>{ console.log('SW registration failed'); });
  }

})();
</script>
</body>
</html>
