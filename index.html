<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù…Ø­Ø±Ø± ÙÙŠØ¯ÙŠÙˆ Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; padding:20px; }
  h1 { text-align:center; color:#1E90FF; }
  .card { background:#222; padding:15px; border-radius:10px; margin-bottom:20px; }
  label { display:block; margin:10px 0 5px; }
  input, select, button { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:none; }
  button { background:#1E90FF; color:#fff; cursor:pointer; }
  video, canvas { width:100%; max-height:400px; background:#000; border-radius:8px; }
</style>
</head>
<body>
<h1>ğŸ¬ Ù…Ø­Ø±Ø± ÙÙŠØ¯ÙŠÙˆ + Ù…ÙˆØ³ÙŠÙ‚Ù‰ (Ø§Ø­ØªØ±Ø§ÙÙŠ)</h1>

<div class="card">
  <label>Ø§Ø®ØªØ± ÙÙŠØ¯ÙŠÙˆ</label>
  <input id="videoFile" type="file" accept="video/*">
  <label>Ø§Ø®ØªØ± Ù…ÙˆØ³ÙŠÙ‚Ù‰</label>
  <input id="audioFile" type="file" accept="audio/*">
  <label>ÙÙ„ØªØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
  <select id="filter">
    <option value="none">Ø¨Ø¯ÙˆÙ†</option>
    <option value="grayscale(100%)">Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯</option>
    <option value="sepia(80%)">Ø³ÙŠØ¨ÙŠØ§</option>
    <option value="brightness(1.3)">Ø³Ø·ÙˆØ¹ Ø£Ø¹Ù„Ù‰</option>
    <option value="contrast(1.3)">ØªØ¨Ø§ÙŠÙ† Ø£Ø¹Ù„Ù‰</option>
  </select>
  <label><input type="checkbox" id="muteOriginal"> Ø¥Ù„ØºØ§Ø¡ ØµÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ</label>
  <button id="export">ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
  <a id="download" style="display:none" download="output.webm">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø§ØªØ¬</a>
</div>

<div class="card">
  <video id="video" controls></video>
  <canvas id="canvas"></canvas>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let audio = null;

document.getElementById('videoFile').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){ video.src = URL.createObjectURL(file); }
});

document.getElementById('audioFile').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){ audio = new Audio(URL.createObjectURL(file)); audio.loop = true; }
});

document.getElementById('export').addEventListener('click', ()=>{
  if(!video.src){ alert("Ø­Ù…Ù‘Ù„ ÙÙŠØ¯ÙŠÙˆ Ø£ÙˆÙ„Ø§Ù‹"); return; }
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const stream = canvas.captureStream(30);

  // Ø¥Ù„ØºØ§Ø¡ ØµÙˆØª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø±
  if(!document.getElementById('muteOriginal').checked){
    video.muted = false;
    stream.addTrack(video.captureStream().getAudioTracks()[0]);
  } else {
    video.muted = true;
  }

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
  if(audio){
    const ctxAudio = new AudioContext();
    const source = ctxAudio.createMediaElementSource(audio);
    const dest = ctxAudio.createMediaStreamDestination();
    source.connect(dest);
    source.connect(ctxAudio.destination);
    if(dest.stream.getAudioTracks()[0]){
      stream.addTrack(dest.stream.getAudioTracks()[0]);
    }
    audio.play();
  }

  const rec = new MediaRecorder(stream, {mimeType:'video/webm'});
  const chunks = [];
  rec.ondataavailable = e=> chunks.push(e.data);
  rec.onstop = ()=>{
    const blob = new Blob(chunks, {type:'video/webm'});
    const url = URL.createObjectURL(blob);
    const a = document.getElementById('download');
    a.href = url;
    a.style.display = 'block';
  };
  rec.start();
  video.play();

  function draw(){
    ctx.filter = document.getElementById('filter').value;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    if(!video.paused && !video.ended){ requestAnimationFrame(draw); }
    else{ rec.stop(); }
  }
  draw();
});
</script>
</body>
</html>
