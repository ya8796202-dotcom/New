<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­ â€” PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù</title>
<meta name="theme-color" content="#0ea5e9" />

<style>
  :root{
    --bg:#0b1220; --glass:rgba(255,255,255,.08); --text:#e6f2ff; --muted:#a9c2d9;
    --accent:#0ea5e9; --accent-2:#22d3ee; --shadow:0 20px 40px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box} html,body{margin:0; min-height:100%; color:var(--text);
    background: radial-gradient(1000px 700px at 10% 10%, #0f1b33 0%, #0b1220 45%, #070c16 100%);
    font-family: "Segoe UI", Tahoma, sans-serif;
  }
  .container{max-width:1100px; margin:0 auto; padding:24px;}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px;}
  .brand{display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:12px; background:var(--glass);
    backdrop-filter: blur(12px); box-shadow: var(--shadow);}
  .brand canvas{width:40px; height:40px; border-radius:10px;}
  .brand .name{font-weight:700} .brand .sub{color:var(--muted); font-size:.9rem}
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  button{appearance:none; border:none; color:#fff; font-weight:600; padding:10px 14px; border-radius:12px; cursor:pointer;
    background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow);}
  button.secondary{background: linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.08)); color:var(--text);}
  button:disabled{opacity:.6; cursor:not-allowed}
  .card{margin-top:16px; border-radius:var(--radius); background:var(--glass); backdrop-filter: blur(18px);
    box-shadow: var(--shadow); overflow:hidden;}
  .toolbar{display:flex; gap:12px; flex-wrap:wrap; padding:12px; border-bottom:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
  .pill{padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.08); color:var(--muted); font-size:.9rem}
  .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px; padding:16px;}
  .panel{padding:12px; border-top:1px solid rgba(255,255,255,.06); display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
  .tile{border-radius:12px; background:rgba(255,255,255,.06); box-shadow: var(--shadow); overflow:hidden;}
  .tile .hd{padding:10px 12px; font-weight:600; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25)}
  .tile .bd{padding:12px}
  .kv{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.08)}
  .kv:last-child{border-bottom:none}
  .kv .k{color:var(--muted)} .kv .v{font-family:Consolas, monospace}
  .list{display:flex; flex-direction:column; gap:6px}
  .tag{display:inline-block; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.10); font-size:.9rem}
  .toast{position:fixed; right:20px; bottom:20px; background:rgba(16,185,129,.15); color:#d1fae5; border:1px solid rgba(16,185,129,.45);
    padding:10px 14px; border-radius:12px; backdrop-filter: blur(10px); box-shadow: var(--shadow); transform: translateY(20px);
    opacity:0; pointer-events:none; transition:.35s ease;}
  .toast.show{transform: translateY(0); opacity:1; pointer-events:auto}
  .offline{position:fixed; left:20px; bottom:20px; background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.4);
    padding:8px 12px; border-radius:10px; backdrop-filter: blur(10px);}
</style>

<link id="appIconLink" rel="icon" type="image/png" />
<link id="manifestLink" rel="manifest" />

</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <canvas id="appIconCanvas" width="128" height="128" aria-hidden="true"></canvas>
      <div>
        <div class="name">ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­</div>
        <div class="sub">PWA ÙˆØ§Ø­Ø¯-Ù…Ù„Ù | ØªÙ‚Ø±ÙŠØ± ØªØ´Ø®ÙŠØµÙŠ | ÙŠØ¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†</div>
      </div>
    </div>
    <div class="actions">
      <button id="installBtn" disabled>ØªØ«Ø¨ÙŠØª</button>
      <button id="scanBtn">ÙØ­Øµ Ø§Ù„Ø¢Ù†</button>
      <button id="copyMdBtn" class="secondary">Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Markdown</button>
      <button id="downloadJsonBtn" class="secondary">ØªÙ†Ø²ÙŠÙ„ JSON</button>
    </div>
  </header>

  <div class="card">
    <div class="toolbar">
      <span class="pill">Ù‡Ø¯Ù Ø§Ù„Ø´Ø¨ÙƒØ©:</span>
      <input id="pingUrl" class="input" type="text" value="https://www.gstatic.com/generate_204" />
      <span class="pill">Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù‚ÙŠØ§Ø³:</span>
      <input id="triesInp" type="number" min="1" max="10" value="4" />
    </div>

    <div id="grid" class="grid" aria-live="polite">
      <!-- ØªÙÙ…Ù„Ø£ Ø¨Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ÙØ­Øµ -->
    </div>

    <div class="panel">
      <span class="pill">Ù†ØµÙŠØ­Ø©: Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø³ØªØ¬Ø¯ Ø§Ø®ØªØµØ§Ø± â€œÙØ­Øµ Ø§Ù„Ø¢Ù†â€ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.</span>
      <span class="tag">Manifest + SW Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù</span>
      <span class="tag">Ø£ÙŠÙ‚ÙˆÙ†Ø© Canvas Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</span>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="offline" class="offline" hidden>Ø£Ù†Øª Ø£ÙˆÙÙ„Ø§ÙŠÙ† â€” Ø³ÙŠØ­ÙØ¸ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙØ­Ø© ÙˆÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„.</div>

<script>
/* ========= Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ø¬Ù‡Ø© ========= */
const $ = sel => document.querySelector(sel);
const showToast = (msg, ok=true) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.12)';
  t.style.color = ok ? '#d1fae5' : '#fecaca';
  t.style.borderColor = ok ? 'rgba(16,185,129,.45)' : 'rgba(239,68,68,.4)';
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 3000);
};

/* ========= Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ========= */
function generateIcon(size=192){
  const c = $('#appIconCanvas'); c.width=size; c.height=size;
  const ctx = c.getContext('2d');
  const g = ctx.createLinearGradient(0,0,size,size);
  g.addColorStop(0,'#0ea5e9'); g.addColorStop(1,'#22d3ee');
  ctx.fillStyle = g; ctx.fillRect(0,0,size,size);

  // Ù…ÙˆØ¬Ø§Øª Ø±Ù‚Ù…ÙŠØ©
  ctx.strokeStyle = 'rgba(255,255,255,.6)';
  ctx.lineWidth = Math.max(2, size*0.02);
  for(let i=0;i<5;i++){
    ctx.beginPath();
    for(let x=0; x<=size; x+=size/40){
      const y = size*0.2 + i*size*0.12 + Math.sin(x/size*Math.PI*2 + i)*size*0.06;
      if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  // Ø±Ù…Ø² â€œÙâ€
  ctx.fillStyle='rgba(255,255,255,.95)';
  ctx.font = `${Math.floor(size*0.5)}px serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.shadowColor='rgba(0,0,0,.3)'; ctx.shadowBlur=size*0.06;
  ctx.fillText('Ù', size/2, size/2);
  return c.toDataURL('image/png');
}

/* ========= Ø­Ù‚Ù† Manifest ========= */
function injectManifest(){
  const icon192 = generateIcon(192);
  const icon512 = generateIcon(512);
  $('#appIconLink').href = icon192;

  const manifest = {
    name: "ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­ â€” ÙˆØ§Ø­Ø¯-Ù…Ù„Ù",
    short_name: "ÙØ­Øµ",
    start_url: ".",
    scope: ".",
    display: "standalone",
    background_color: "#0b1220",
    theme_color: "#0ea5e9",
    description: "ØªØ´Ø®ÙŠØµ ØªÙ‚Ù†ÙŠ Ø´Ø§Ù…Ù„: WebGL/GPUØŒ Ø§Ù„Ø´Ø¨ÙƒØ©ØŒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŒ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©ØŒ ÙˆØ¯Ø¹Ù… APIÙ‘Ø§Øª.",
    icons: [
      { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
    ],
    shortcuts: [
      { name: "ÙØ­Øµ Ø§Ù„Ø¢Ù†", url: "./?scan=1", description: "Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø±Ø©" },
      { name: "Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±", url: "./?md=1", description: "Ù†Ø³Ø® Markdown" }
    ]
  };
  const manifestStr = JSON.stringify(manifest);
  const manifestDataUrl = 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(manifestStr)));
  $('#manifestLink').href = manifestDataUrl;
  showToast('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª âœ…');
}

/* ========= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‚ÙŠØ§Ø³ ========= */
async function measureLatency(url, tries=4){
  const times = [];
  for(let i=0;i<tries;i++){
    const t0 = performance.now();
    try{
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ÙƒØ§Ø´
      await fetch(url, {cache:'no-store', mode:'cors'});
      const t1 = performance.now();
      times.push(t1 - t0);
    }catch(e){
      times.push(null);
    }
  }
  const valid = times.filter(t=>t!==null);
  const avg = valid.length ? valid.reduce((a,b)=>a+b,0)/valid.length : null;
  const min = valid.length ? Math.min(...valid) : null;
  const max = valid.length ? Math.max(...valid) : null;
  return { url, tries, times, avg, min, max };
}
function estimateDownlink(){
  const c = navigator.connection || navigator.webkitConnection || navigator.mozConnection;
  if(!c) return null;
  return { downlink: c.downlink, rtt: c.rtt, effectiveType: c.effectiveType, saveData: c.saveData || false };
}
async function getBattery(){
  if(!navigator.getBattery) return null;
  try{
    const b = await navigator.getBattery();
    return { charging: b.charging, level: Math.round(b.level*100), chargingTime: b.chargingTime, dischargingTime: b.dischargingTime };
  }catch{ return null }
}
function getMemory(){
  const m = performance && performance.memory;
  if(!m) return null;
  return {
    jsHeapSizeLimit: m.jsHeapSizeLimit,
    totalJSHeapSize: m.totalJSHeapSize,
    usedJSHeapSize: m.usedJSHeapSize
  };
}
async function getStorageEstimate(){
  if(!navigator.storage || !navigator.storage.estimate) return null;
  try{
    const e = await navigator.storage.estimate();
    return { quota: e.quota || null, usage: e.usage || null };
  }catch{ return null }
}
function getWebGLInfo(){
  try{
    const cn = document.createElement('canvas');
    const gl = cn.getContext('webgl') || cn.getContext('experimental-webgl');
    if(!gl) return { supported:false };
    const dbgInfo = gl.getExtension('WEBGL_debug_renderer_info');
    const vendor = dbgInfo ? gl.getParameter(dbgInfo.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
    const renderer = dbgInfo ? gl.getParameter(dbgInfo.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
    return {
      supported:true,
      vendor, renderer,
      version: gl.getParameter(gl.VERSION),
      shading: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
      maxTexSize: gl.getParameter(gl.MAX_TEXTURE_SIZE),
      maxTextureImageUnits: gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS),
      maxCubeMapSize: gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE)
    };
  }catch(e){
    return { supported:false, error: String(e) };
  }
}
function getAPISupport(){
  const apis = {
    webgl: !!(document.createElement('canvas').getContext('webgl')),
    webgpu: !!navigator.gpu,
    webrtc: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
    bluetooth: !!navigator.bluetooth,
    usb: !!navigator.usb,
    serial: !!navigator.serial,
    hid: !!navigator.hid,
    nfc: !!(navigator.nfc || (window.NDEFReader)),
    wakeLock: !!navigator.wakeLock,
    share: !!navigator.share,
    clipboard: !!navigator.clipboard,
    localFonts: !!(window.queryLocalFonts),
    fileSystemAccess: !!(window.showOpenFilePicker),
    codecs_av1: !!(window.VideoDecoder && VideoDecoder.isConfigSupported) // Ù…Ø¤Ø´Ø± Ø¨Ø³ÙŠØ·
  };
  return apis;
}
async function getPermissions(){
  if(!navigator.permissions) return null;
  const names = ['geolocation','notifications','camera','microphone','clipboard-read','clipboard-write'];
  const res = {};
  for(const n of names){
    try{
      const st = await navigator.permissions.query({name:n});
      res[n] = st.state;
    }catch{
      res[n] = 'unknown';
    }
  }
  return res;
}

/* ========= Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ========= */
function kv(key, val){
  const wrap = document.createElement('div'); wrap.className='kv';
  const k = document.createElement('div'); k.className='k'; k.textContent = key;
  const v = document.createElement('div'); v.className='v'; v.textContent = val;
  wrap.appendChild(k); wrap.appendChild(v);
  return wrap;
}
function tile(title, bodyEl){
  const t = document.createElement('div'); t.className='tile';
  const hd = document.createElement('div'); hd.className='hd'; hd.textContent = title;
  const bd = document.createElement('div'); bd.className='bd'; bd.appendChild(bodyEl);
  t.appendChild(hd); t.appendChild(bd); return t;
}
function renderReport(rep){
  const grid = $('#grid'); grid.innerHTML='';
  // Ø¹Ø§Ù…Ø©
  const gBody = document.createElement('div');
  gBody.appendChild(kv('Ø§Ù„Ù…ØªØµÙØ­', navigator.userAgent));
  gBody.appendChild(kv('Ø§Ù„Ù…Ù†ØµØ©', navigator.platform || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
  gBody.appendChild(kv('Ø§Ù„Ù„ØºØ©', navigator.language));
  gBody.appendChild(kv('Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', String(navigator.onLine)));
  gBody.appendChild(kv('Ø´Ø§Ø´Ø©', `${window.screen.width}Ã—${window.screen.height}`));
  grid.appendChild(tile('Ø¹Ø§Ù…', gBody));

  // Ø§Ù„Ø´Ø¨ÙƒØ©
  const nBody = document.createElement('div');
  const net = rep.network;
  if(net) {
    nBody.appendChild(kv('Downlink (Mbps ØªÙ‚Ø¯ÙŠØ±ÙŠ)', net.downlink ?? 'N/A'));
    nBody.appendChild(kv('RTT (ms)', net.rtt ?? 'N/A'));
    nBody.appendChild(kv('Ù†ÙˆØ¹ Ø§Ù„Ø´Ø¨ÙƒØ©', net.effectiveType ?? 'N/A'));
    nBody.appendChild(kv('ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', String(net.saveData)));
  } else {
    nBody.appendChild(kv('Ø­Ø§Ù„Ø©', 'Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§ØªØµØ§Ù„'));
  }
  const ping = rep.latency;
  if(ping){
    nBody.appendChild(kv('Ø§Ù„Ù…ØªÙˆØ³Ø· (ms)', ping.avg !== null ? ping.avg.toFixed(1) : 'ÙØ´Ù„'));
    nBody.appendChild(kv('Ø§Ù„Ø£Ø¯Ù†Ù‰ (ms)', ping.min !== null ? ping.min.toFixed(1) : 'ÙØ´Ù„'));
    nBody.appendChild(kv('Ø§Ù„Ø£Ø¹Ù„Ù‰ (ms)', ping.max !== null ? ping.max.toFixed(1) : 'ÙØ´Ù„'));
  }
  grid.appendChild(tile('Ø§Ù„Ø´Ø¨ÙƒØ©', nBody));

  // WebGL/GPU
  const wBody = document.createElement('div');
  const w = rep.webgl;
  wBody.appendChild(kv('Ù…Ø¯Ø¹ÙˆÙ…', String(!!(w && w.supported))));
  if(w && w.supported){
    wBody.appendChild(kv('Vendor', w.vendor));
    wBody.appendChild(kv('Renderer', w.renderer));
    wBody.appendChild(kv('Version', w.version));
    wBody.appendChild(kv('GLSL', w.shading));
    wBody.appendChild(kv('Max Texture Size', w.maxTexSize));
    wBody.appendChild(kv('Texture Units', w.maxTextureImageUnits));
  }
  grid.appendChild(tile('WebGL/GPU', wBody));

  // Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
  const mBody = document.createElement('div');
  const mem = rep.memory;
  if(mem){
    mBody.appendChild(kv('JS Heap Limit', mem.jsHeapSizeLimit));
    mBody.appendChild(kv('Total JS Heap', mem.totalJSHeapSize));
    mBody.appendChild(kv('Used JS Heap', mem.usedJSHeapSize));
  }else{
    mBody.appendChild(kv('Ø§Ù„Ø°Ø§ÙƒØ±Ø©', 'ØºÙŠØ± Ù…ØªØ§Ø­'));
  }
  const st = rep.storage;
  if(st){
    mBody.appendChild(kv('Ø§Ù„Ø­ØµØ© (bytes)', st.quota ?? 'N/A'));
    mBody.appendChild(kv('Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (bytes)', st.usage ?? 'N/A'));
  }else{
    mBody.appendChild(kv('Ø§Ù„ØªØ®Ø²ÙŠÙ†', 'ØºÙŠØ± Ù…ØªØ§Ø­'));
  }
  grid.appendChild(tile('Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†', mBody));

  // Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
  const bBody = document.createElement('div');
  const bat = rep.battery;
  if(bat){
    bBody.appendChild(kv('Ø§Ù„Ø´Ø­Ù†', String(bat.charging)));
    bBody.appendChild(kv('Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (%)', String(bat.level)));
    bBody.appendChild(kv('Ø²Ù…Ù† Ø§Ù„Ø´Ø­Ù† (Ø«)', String(bat.chargingTime)));
    bBody.appendChild(kv('Ø²Ù…Ù† Ø§Ù„ØªÙØ±ÙŠØº (Ø«)', String(bat.dischargingTime)));
  }else{
    bBody.appendChild(kv('Ø­Ø§Ù„Ø©', 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©'));
  }
  grid.appendChild(tile('Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©', bBody));

  // Ø¯Ø¹Ù… APIÙ‘Ø§Øª
  const aBody = document.createElement('div'); aBody.className='list';
  Object.entries(rep.apis).forEach(([k,v])=>{
    const el = document.createElement('div'); el.className='kv';
    const key = document.createElement('div'); key.className='k'; key.textContent = k;
    const val = document.createElement('div'); val.className='v'; val.textContent = String(v);
    el.appendChild(key); el.appendChild(val); aBody.appendChild(el);
  });
  grid.appendChild(tile('Ø¯Ø¹Ù… APIÙ‘Ø§Øª', aBody));

  // ØµÙ„Ø§Ø­ÙŠØ§Øª
  const pBody = document.createElement('div');
  const perms = rep.permissions;
  if(perms){
    Object.entries(perms).forEach(([k,v])=> pBody.appendChild(kv(k, v)));
  }else{
    pBody.appendChild(kv('Ø­Ø§Ù„Ø©', 'ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©'));
  }
  grid.appendChild(tile('Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª', pBody));
}

/* ========= ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ========= */
async function scan(){
  showToast('Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµâ€¦');
  const url = $('#pingUrl').value.trim() || 'https://www.gstatic.com/generate_204';
  const tries = Math.max(1, Math.min(10, Number($('#triesInp').value)||4));

  const [latency, network, battery, memory, storage, webgl, apis, permissions] = await Promise.all([
    measureLatency(url, tries),
    Promise.resolve(estimateDownlink()),
    getBattery(),
    Promise.resolve(getMemory()),
    getStorageEstimate(),
    Promise.resolve(getWebGLInfo()),
    Promise.resolve(getAPISupport()),
    getPermissions()
  ]);

  const report = {
    timestamp: new Date().toISOString(),
    urlTarget: url,
    latency, network, battery, memory, storage, webgl, apis, permissions
  };
  window._report = report;
  renderReport(report);
  showToast('Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ âœ…');
  return report;
}

/* ========= ØªØµØ¯ÙŠØ± JSON / Markdown ========= */
function downloadJson(){
  const rep = window._report;
  if(!rep){ showToast('Ù†ÙÙ‘Ø° ÙØ­ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹', false); return; }
  const blob = new Blob([JSON.stringify(rep, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url; a.download = `diagnostics-${ts}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 3000);
  showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ JSON âœ…');
}
function toMarkdown(rep){
  const lines = [];
  lines.push(`# ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…ØªØµÙØ­`);
  lines.push(`- Ø§Ù„ÙˆÙ‚Øª: ${rep.timestamp}`);
  lines.push(`- Ù‡Ø¯Ù Ø§Ù„Ø´Ø¨ÙƒØ©: ${rep.urlTarget}`);
  lines.push(``);
  lines.push(`## Ø§Ù„Ø´Ø¨ÙƒØ©`);
  const lat = rep.latency;
  lines.push(`- Ø§Ù„Ù…ØªÙˆØ³Ø·: ${lat.avg!==null?lat.avg.toFixed(1):'ÙØ´Ù„'} ms | Ø§Ù„Ø£Ø¯Ù†Ù‰: ${lat.min!==null?lat.min.toFixed(1):'ÙØ´Ù„'} | Ø§Ù„Ø£Ø¹Ù„Ù‰: ${lat.max!==null?lat.max.toFixed(1):'ÙØ´Ù„'}`);
  const net = rep.network || {};
  lines.push(`- Downlink: ${net.downlink ?? 'N/A'} Mbps | RTT: ${net.rtt ?? 'N/A'} ms | Ø§Ù„Ù†ÙˆØ¹: ${net.effectiveType ?? 'N/A'} | ØªÙˆÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${net.saveData ?? 'N/A'}`);
  lines.push(``);
  lines.push(`## WebGL/GPU`);
  const w = rep.webgl || {}; lines.push(`- Ù…Ø¯Ø¹ÙˆÙ…: ${w.supported ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}`);
  if(w.supported){
    lines.push(`- Vendor: ${w.vendor}`); lines.push(`- Renderer: ${w.renderer}`); lines.push(`- Version: ${w.version}`);
    lines.push(`- GLSL: ${w.shading}`); lines.push(`- Max Texture Size: ${w.maxTexSize}`); lines.push(`- Texture Units: ${w.maxTextureImageUnits}`);
  }
  lines.push(``);
  lines.push(`## Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†`);
  const mem = rep.memory || {};
  lines.push(`- JS Heap Used: ${mem.usedJSHeapSize ?? 'N/A'} / Total: ${mem.totalJSHeapSize ?? 'N/A'} (Limit: ${mem.jsHeapSizeLimit ?? 'N/A'})`);
  const st = rep.storage || {};
  lines.push(`- Ø§Ù„Ø­ØµØ©: ${st.quota ?? 'N/A'} | Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: ${st.usage ?? 'N/A'}`);
  lines.push(``);
  lines.push(`## Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©`);
  const bat = rep.battery || {};
  lines.push(`- Ø´Ø­Ù†: ${bat.charging ?? 'N/A'} | Ù…Ø³ØªÙˆÙ‰: ${bat.level ?? 'N/A'}% | Ø²Ù…Ù† Ø§Ù„Ø´Ø­Ù†: ${bat.chargingTime ?? 'N/A'} | Ø§Ù„ØªÙØ±ÙŠØº: ${bat.dischargingTime ?? 'N/A'}`);
  lines.push(``);
  lines.push(`## Ø¯Ø¹Ù… APIÙ‘Ø§Øª`);
  Object.entries(rep.apis || {}).forEach(([k,v])=> lines.push(`- ${k}: ${v}`));
  lines.push(``);
  lines.push(`## ØµÙ„Ø§Ø­ÙŠØ§Øª`);
  Object.entries(rep.permissions || {}).forEach(([k,v])=> lines.push(`- ${k}: ${v}`));
  return lines.join('\n');
}
function copyMarkdown(){
  const rep = window._report;
  if(!rep){ showToast('Ù†ÙÙ‘Ø° ÙØ­ØµØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹', false); return; }
  const md = toMarkdown(rep);
  navigator.clipboard.writeText(md).then(()=> showToast('Ù†ÙØ³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Markdown âœ…'));
}

/* ========= Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ========= */
function updateOnline(){ $('#offline').hidden = navigator.onLine; }
window.addEventListener('online', updateOnline);
window.addEventListener('offline', updateOnline);

/* ========= ØªØ«Ø¨ÙŠØª PWA ========= */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  $('#installBtn').disabled = false;
  showToast('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ«Ø¨ÙŠØª â€” Ø§Ø¶ØºØ· Ø²Ø± ØªØ«Ø¨ÙŠØª');
});
$('#installBtn').addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  $('#installBtn').disabled = true;
  showToast(outcome==='accepted' ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ğŸ‰' : 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª');
});

/* ========= Service Worker ÙˆØ§Ø­Ø¯-Ù…Ù„Ù ========= */
async function registerSW(){
  const swCode = `
    const CACHE = 'diag-pwa-cache-v1';
    const CORE = ['.'];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      const req = e.request;
      const url = new URL(req.url);
      if(req.method==='GET' && url.origin===self.location.origin){
        e.respondWith(
          caches.match(req).then(res=>{
            return res || fetch(req).then(network=>{
              const copy = network.clone();
              caches.open(CACHE).then(c=>c.put(req, copy));
              return network;
            }).catch(()=> caches.match('.'));
          })
        );
      }
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  try{
    await navigator.serviceWorker.register(swUrl, { scope: '.' });
    showToast('Service Worker Ø¬Ø§Ù‡Ø² ğŸ›¡ï¸');
    setTimeout(()=> URL.revokeObjectURL(swUrl), 4000);
  }catch(err){
    console.error(err);
    showToast('ØªØ¹Ø°Ù‘Ø± ØªØ³Ø¬ÙŠÙ„ Service Worker', false);
  }
}

/* ========= ØªÙ‡ÙŠØ¦Ø© ========= */
function init(){
  injectManifest();
  updateOnline();
  registerSW();

  $('#scanBtn').addEventListener('click', scan);
  $('#copyMdBtn').addEventListener('click', copyMarkdown);
  $('#downloadJsonBtn').addEventListener('click', downloadJson);

  const params = new URLSearchParams(location.search);
  if(params.has('scan')) scan();
  if(params.has('md')) copyMarkdown();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
